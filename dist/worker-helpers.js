"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.didRulesChange = didRulesChange;
exports.findESLintDirectory = findESLintDirectory;
exports.getCLIEngineOptions = getCLIEngineOptions;
exports.getCLIEngineRules = getCLIEngineRules;
exports.getConfigForFile = getConfigForFile;
exports.getESLintFromDirectory = getESLintFromDirectory;
exports.getESLintInstance = getESLintInstance;
exports.getESLintOptions = getESLintOptions;
exports.getESLintRules = getESLintRules;
exports.getNodePrefixPath = getNodePrefixPath;
exports.getRelativePath = getRelativePath;
exports.log = log;
exports.refreshModulesPath = refreshModulesPath;

var _path = _interopRequireDefault(require("path"));

var _util = _interopRequireDefault(require("util"));

var _fsPlus = _interopRequireDefault(require("fs-plus"));

var _child_process = _interopRequireDefault(require("child_process"));

var _resolveEnv = _interopRequireDefault(require("resolve-env"));

var _atomLinter = require("atom-linter");

var _consistentPath = _interopRequireDefault(require("consistent-path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* global emit */
const Cache = {
  ESLINT_LOCAL_PATH: _path.default.normalize(_path.default.join(__dirname, '..', 'node_modules', 'eslint')),
  NODE_PREFIX_PATH: null,
  LAST_MODULES_PATH: null
};
/**
 * Takes a path and translates `~` to the user's home directory, and replaces
 * all environment variables with their value.
 * @param  {string} path The path to remove "strangeness" from
 * @return {string}      The cleaned path
 */

const cleanPath = path => path ? (0, _resolveEnv.default)(_fsPlus.default.normalize(path)) : '';
/**
 * @returns {string}
 */


function getNodePrefixPath() {
  if (Cache.NODE_PREFIX_PATH === null) {
    const npmCommand = process.platform === 'win32' ? 'npm.cmd' : 'npm';

    try {
      Cache.NODE_PREFIX_PATH = _child_process.default.spawnSync(npmCommand, ['get', 'prefix'], {
        env: { ...process.env,
          PATH: (0, _consistentPath.default)()
        }
      }).output[1].toString().trim();
    } catch (e) {
      const errMsg = 'Unable to execute `npm get prefix`. Please make sure ' + 'Atom is getting $PATH correctly.';
      throw new Error(errMsg);
    }
  }

  return Cache.NODE_PREFIX_PATH;
}
/**
 * @param {string} dirPath
 * @returns {boolean}
 */


function isDirectory(dirPath) {
  let isDir;

  try {
    isDir = _fsPlus.default.statSync(dirPath).isDirectory();
  } catch (e) {
    isDir = false;
  }

  return isDir;
}

let fallbackForGlobalErrorThrown = false;
/**
 * @param {string} modulesDir
 * @param {object} config
 * @param {string} projectPath
 * @param {boolean} fallbackForGlobal
 * @returns {{ path: string, type: 'local project' | 'global' | 'advanced specified' | 'bundled fallback' }}
 */

function findESLintDirectory(modulesDir, config, projectPath, fallbackForGlobal = false) {
  let eslintDir = null;
  let locationType = null;

  if (config.global.useGlobalEslint && !fallbackForGlobal) {
    locationType = 'global';
    const configGlobal = cleanPath(config.global.globalNodePath);
    const prefixPath = configGlobal || getNodePrefixPath(); // NPM on Windows and Yarn on all platforms

    eslintDir = _path.default.join(prefixPath, 'node_modules', 'eslint');

    if (!isDirectory(eslintDir)) {
      // NPM on platforms other than Windows
      eslintDir = _path.default.join(prefixPath, 'lib', 'node_modules', 'eslint');
    }
  } else if (!config.advanced.localNodeModules) {
    locationType = 'local project';
    eslintDir = _path.default.join(modulesDir || '', 'eslint');
  } else if (_path.default.isAbsolute(cleanPath(config.advanced.localNodeModules))) {
    locationType = 'advanced specified';
    eslintDir = _path.default.join(cleanPath(config.advanced.localNodeModules), 'eslint');
  } else {
    locationType = 'advanced specified';
    eslintDir = _path.default.join(projectPath || '', cleanPath(config.advanced.localNodeModules), 'eslint');
  }

  if (isDirectory(eslintDir)) {
    return {
      path: eslintDir,
      type: locationType
    };
  }

  if (config.global.useGlobalEslint && !fallbackForGlobal) {
    if (!fallbackForGlobalErrorThrown) {
      // Throw the error only once to prevent performance issues
      fallbackForGlobalErrorThrown = true;
      console.error(`Global ESLint is not found, falling back to other Eslint installations...
        Please ensure the global Node path is set correctly.
        If you wanted to use a local installation of Eslint, disable Global Eslint option in the linter-eslint config.`);
    }

    return findESLintDirectory(modulesDir, config, projectPath, true);
  }

  return {
    path: Cache.ESLINT_LOCAL_PATH,
    type: 'bundled fallback'
  };
}
/**
 * @param {string} modulesDir
 * @param {object} config
 * @param {string} projectPath
 * @returns {import("eslint")}
 */


function getESLintFromDirectory(modulesDir, config, projectPath) {
  const {
    path: ESLintDirectory
  } = findESLintDirectory(modulesDir, config, projectPath);

  try {
    // eslint-disable-next-line import/no-dynamic-require
    return require(ESLintDirectory);
  } catch (e) {
    if (config.global.useGlobalEslint && e.code === 'MODULE_NOT_FOUND') {
      throw new Error('ESLint not found, try restarting Atom to clear caches.');
    } // eslint-disable-next-line import/no-dynamic-require


    return require(Cache.ESLINT_LOCAL_PATH);
  }
}
/**
 * @param {string} modulesDir
 */


function refreshModulesPath(modulesDir) {
  if (Cache.LAST_MODULES_PATH !== modulesDir) {
    Cache.LAST_MODULES_PATH = modulesDir;
    process.env.NODE_PATH = modulesDir || ''; // eslint-disable-next-line no-underscore-dangle

    require('module').Module._initPaths();
  }
}
/**
 * @param {string} fileDir
 * @param {object} config
 * @param {string} projectPath
 * @returns {import("eslint")}
 */


function getESLintInstance(fileDir, config, projectPath) {
  const modulesDir = _path.default.dirname((0, _atomLinter.findCached)(fileDir, 'node_modules/eslint') || '');

  refreshModulesPath(modulesDir);
  return getESLintFromDirectory(modulesDir, config, projectPath);
}
/**
 * console.log
 * @param  {any} args
 * @return {void}
 */


function log(...args) {
  const obj = args.length === 1 ? args[0] : args;
  let str;

  try {
    str = JSON.stringify(obj);
  } catch (e) {
    str = _util.default.inspect(obj);
  }

  emit('log', str);
}
/**
 * @param {import("eslint")} eslint
 * @param {string} filePath
 */


async function getConfigForFile(eslint, filePath) {
  try {
    const cli = new eslint.ESLint();
    return cli.calculateConfigForFile(filePath);
  } catch (e) {// eslint >= 7: config not found
  }

  try {
    const cli = new eslint.CLIEngine();
    return cli.getConfigForFile(filePath);
  } catch (e) {// eslint <= 7: config not found
  } // No configuration was found


  return null;
}
/**
 * @param {string} fileDir
 * @param {string} filePath
 * @param {object} config
 * @param {string} projectPath
 * @returns {string}
 */


function getRelativePath(fileDir, filePath, config, projectPath) {
  const ignoreFile = config.advanced.disableEslintIgnore ? null : (0, _atomLinter.findCached)(fileDir, '.eslintignore'); // If we can find an .eslintignore file, we can set cwd there
  // (because they are expected to be at the project root)

  if (ignoreFile) {
    const ignoreDir = _path.default.dirname(ignoreFile);

    process.chdir(ignoreDir);
    return _path.default.relative(ignoreDir, filePath);
  } // Otherwise, we'll set the cwd to the atom project root as long as that exists


  if (projectPath) {
    process.chdir(projectPath);
    return _path.default.relative(projectPath, filePath);
  } // If all else fails, use the file location itself


  process.chdir(fileDir);
  return _path.default.basename(filePath);
}
/**
 * @param {object} config
 * @param {string} filePath
 */


function getRulePaths(config, filePath) {
  return config.advanced.eslintRulesDirs.map(path => {
    const rulesDir = cleanPath(path);

    if (!_path.default.isAbsolute(rulesDir)) {
      return (0, _atomLinter.findCached)(_path.default.dirname(filePath), rulesDir);
    }

    return rulesDir;
  }).filter(path => path);
}
/**
 * @param {string} type
 * @param {string[]} rules
 * @param {object} config
 * @param {string} filePath
 * @param {object} fileConfig
 */


function getCLIEngineOptions(type, config, rules, filePath, fileConfig) {
  const cliEngineConfig = {
    rules,
    rulePaths: getRulePaths(config, filePath),
    ignore: !config.advanced.disableEslintIgnore,
    fix: type === 'fix'
  };

  if (fileConfig === null && config.global.eslintrcPath) {
    // If we didn't find a configuration use the fallback from the settings
    cliEngineConfig.configFile = cleanPath(config.global.eslintrcPath);
  }

  return cliEngineConfig;
}
/**
 * @param {string} type
 * @param {string[]} rules
 * @param {object} config
 * @param {string} filePath
 * @param {object} fileConfig
 */


function getESLintOptions(type, config, rules, filePath, fileConfig) {
  const eslintConfig = {
    overrideConfig: {
      rules
    },
    rulePaths: getRulePaths(config, filePath),
    ignore: !config.advanced.disableEslintIgnore,
    fix: type === 'fix'
  };

  if (fileConfig === null && config.global.eslintrcPath) {
    // If we didn't find a configuration use the fallback from the settings
    eslintConfig.overrideConfigFile = cleanPath(config.global.eslintrcPath);
  }

  return eslintConfig;
}
/**
 * Gets the list of rules used for a lint job
 * @param  {import("eslint").CLIEngine} engine The CLIEngine instance used for the lint job
 * @return {Map}              A Map of the rules used, rule names as keys, rule
 *                            properties as the contents.
 */


function getCLIEngineRules(engine) {
  // eslint <= 7: Pull the list of rules used directly from the CLIEngine
  if (typeof engine.getRules === 'function') {
    return engine.getRules();
  } // Attempt to use the internal (undocumented) `linter` instance attached to
  // the CLIEngine to get the loaded rules (including plugin rules).
  // Added in ESLint v4


  if (Object.prototype.hasOwnProperty.call(engine, 'linter')) {
    return engine.linter.getRules();
  } // Older versions of ESLint don't (easily) support getting a list of rules


  return new Map();
}
/**
 * Gets the list of rules used for a lint job
 * @param  {import("eslint").ESLint} engine The ESLint instance used for the lint job
 * @return {Promise<Map>}              A Map of the rules used, rule names as keys, rule
 *                            properties as the contents.
 */


async function getESLintRules(engine, {
  filePath
}) {
  const response = await engine.calculateConfigForFile(filePath);
  return new Map(Object.entries(response.rules));
}
/**
 * Given an exiting rule list and a new rule list, determines whether there
 * have been changes.
 * NOTE: This only accounts for presence of the rules, changes to their metadata
 * are not taken into account.
 * @param  {Map} newRules     A Map of the new rules
 * @param  {Map} currentRules A Map of the current rules
 * @return {boolean}             Whether or not there were changes
 */


function didRulesChange(currentRules, newRules) {
  return !(currentRules.size === newRules.size && Array.from(currentRules.keys()).every(ruleId => newRules.has(ruleId)));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93b3JrZXItaGVscGVycy5qcyJdLCJuYW1lcyI6WyJDYWNoZSIsIkVTTElOVF9MT0NBTF9QQVRIIiwiUGF0aCIsIm5vcm1hbGl6ZSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJOT0RFX1BSRUZJWF9QQVRIIiwiTEFTVF9NT0RVTEVTX1BBVEgiLCJjbGVhblBhdGgiLCJwYXRoIiwiZnMiLCJnZXROb2RlUHJlZml4UGF0aCIsIm5wbUNvbW1hbmQiLCJwcm9jZXNzIiwicGxhdGZvcm0iLCJDaGlsZFByb2Nlc3MiLCJzcGF3blN5bmMiLCJlbnYiLCJQQVRIIiwib3V0cHV0IiwidG9TdHJpbmciLCJ0cmltIiwiZSIsImVyck1zZyIsIkVycm9yIiwiaXNEaXJlY3RvcnkiLCJkaXJQYXRoIiwiaXNEaXIiLCJzdGF0U3luYyIsImZhbGxiYWNrRm9yR2xvYmFsRXJyb3JUaHJvd24iLCJmaW5kRVNMaW50RGlyZWN0b3J5IiwibW9kdWxlc0RpciIsImNvbmZpZyIsInByb2plY3RQYXRoIiwiZmFsbGJhY2tGb3JHbG9iYWwiLCJlc2xpbnREaXIiLCJsb2NhdGlvblR5cGUiLCJnbG9iYWwiLCJ1c2VHbG9iYWxFc2xpbnQiLCJjb25maWdHbG9iYWwiLCJnbG9iYWxOb2RlUGF0aCIsInByZWZpeFBhdGgiLCJhZHZhbmNlZCIsImxvY2FsTm9kZU1vZHVsZXMiLCJpc0Fic29sdXRlIiwidHlwZSIsImNvbnNvbGUiLCJlcnJvciIsImdldEVTTGludEZyb21EaXJlY3RvcnkiLCJFU0xpbnREaXJlY3RvcnkiLCJyZXF1aXJlIiwiY29kZSIsInJlZnJlc2hNb2R1bGVzUGF0aCIsIk5PREVfUEFUSCIsIk1vZHVsZSIsIl9pbml0UGF0aHMiLCJnZXRFU0xpbnRJbnN0YW5jZSIsImZpbGVEaXIiLCJkaXJuYW1lIiwibG9nIiwiYXJncyIsIm9iaiIsImxlbmd0aCIsInN0ciIsIkpTT04iLCJzdHJpbmdpZnkiLCJVdGlsIiwiaW5zcGVjdCIsImVtaXQiLCJnZXRDb25maWdGb3JGaWxlIiwiZXNsaW50IiwiZmlsZVBhdGgiLCJjbGkiLCJFU0xpbnQiLCJjYWxjdWxhdGVDb25maWdGb3JGaWxlIiwiQ0xJRW5naW5lIiwiZ2V0UmVsYXRpdmVQYXRoIiwiaWdub3JlRmlsZSIsImRpc2FibGVFc2xpbnRJZ25vcmUiLCJpZ25vcmVEaXIiLCJjaGRpciIsInJlbGF0aXZlIiwiYmFzZW5hbWUiLCJnZXRSdWxlUGF0aHMiLCJlc2xpbnRSdWxlc0RpcnMiLCJtYXAiLCJydWxlc0RpciIsImZpbHRlciIsImdldENMSUVuZ2luZU9wdGlvbnMiLCJydWxlcyIsImZpbGVDb25maWciLCJjbGlFbmdpbmVDb25maWciLCJydWxlUGF0aHMiLCJpZ25vcmUiLCJmaXgiLCJlc2xpbnRyY1BhdGgiLCJjb25maWdGaWxlIiwiZ2V0RVNMaW50T3B0aW9ucyIsImVzbGludENvbmZpZyIsIm92ZXJyaWRlQ29uZmlnIiwib3ZlcnJpZGVDb25maWdGaWxlIiwiZ2V0Q0xJRW5naW5lUnVsZXMiLCJlbmdpbmUiLCJnZXRSdWxlcyIsIk9iamVjdCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImxpbnRlciIsIk1hcCIsImdldEVTTGludFJ1bGVzIiwicmVzcG9uc2UiLCJlbnRyaWVzIiwiZGlkUnVsZXNDaGFuZ2UiLCJjdXJyZW50UnVsZXMiLCJuZXdSdWxlcyIsInNpemUiLCJBcnJheSIsImZyb20iLCJrZXlzIiwiZXZlcnkiLCJydWxlSWQiLCJoYXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQVJBO0FBVUEsTUFBTUEsS0FBSyxHQUFHO0FBQ1pDLEVBQUFBLGlCQUFpQixFQUFFQyxjQUFLQyxTQUFMLENBQWVELGNBQUtFLElBQUwsQ0FBVUMsU0FBVixFQUFxQixJQUFyQixFQUEyQixjQUEzQixFQUEyQyxRQUEzQyxDQUFmLENBRFA7QUFFWkMsRUFBQUEsZ0JBQWdCLEVBQUUsSUFGTjtBQUdaQyxFQUFB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RUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDTyxTQUFTd0IsY0FBVCxDQUF3QkMsWUFBeEIsRUFBc0NDLFFBQXRDLEVBQWdEO0FBQ3JELFNBQU8sRUFBRUQsWUFBWSxDQUFDRSxJQUFiLEtBQXNCRCxRQUFRLENBQUNDLElBQS9CLElBQ0pDLEtBQUssQ0FBQ0MsSUFBTixDQUFXSixZQUFZLENBQUNLLElBQWIsRUFBWCxFQUFnQ0MsS0FBaEMsQ0FBdUNDLE1BQUQsSUFBWU4sUUFBUSxDQUFDTyxHQUFULENBQWFELE1BQWIsQ0FBbEQsQ0FERSxDQUFQO0FBRUQiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWwgZW1pdCAqL1xuXG5pbXBvcnQgUGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IFV0aWwgZnJvbSAndXRpbCdcbmltcG9ydCBmcyBmcm9tICdmcy1wbHVzJ1xuaW1wb3J0IENoaWxkUHJvY2VzcyBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHJlc29sdmVFbnYgZnJvbSAncmVzb2x2ZS1lbnYnXG5pbXBvcnQgeyBmaW5kQ2FjaGVkIH0gZnJvbSAnYXRvbS1saW50ZXInXG5pbXBvcnQgZ2V0UGF0aCBmcm9tICdjb25zaXN0ZW50LXBhdGgnXG5cbmNvbnN0IENhY2hlID0ge1xuICBFU0xJTlRfTE9DQUxfUEFUSDogUGF0aC5ub3JtYWxpemUoUGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJ25vZGVfbW9kdWxlcycsICdlc2xpbnQnKSksXG4gIE5PREVfUFJFRklYX1BBVEg6IG51bGwsXG4gIExBU1RfTU9EVUxFU19QQVRIOiBudWxsXG59XG5cbi8qKlxuICogVGFrZXMgYSBwYXRoIGFuZCB0cmFuc2xhdGVzIGB+YCB0byB0aGUgdXNlcidzIGhvbWUgZGlyZWN0b3J5LCBhbmQgcmVwbGFjZXNcbiAqIGFsbCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgd2l0aCB0aGVpciB2YWx1ZS5cbiAqIEBwYXJhbSAge3N0cmluZ30gcGF0aCBUaGUgcGF0aCB0byByZW1vdmUgXCJzdHJhbmdlbmVzc1wiIGZyb21cbiAqIEByZXR1cm4ge3N0cmluZ30gICAgICBUaGUgY2xlYW5lZCBwYXRoXG4gKi9cbmNvbnN0IGNsZWFuUGF0aCA9IChwYXRoKSA9PiAocGF0aCA/IHJlc29sdmVFbnYoZnMubm9ybWFsaXplKHBhdGgpKSA6ICcnKVxuXG4vKipcbiAqIEByZXR1cm5zIHtzdHJpbmd9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXROb2RlUHJlZml4UGF0aCgpIHtcbiAgaWYgKENhY2hlLk5PREVfUFJFRklYX1BBVEggPT09IG51bGwpIHtcbiAgICBjb25zdCBucG1Db21tYW5kID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/ICducG0uY21kJyA6ICducG0nXG4gICAgdHJ5IHtcbiAgICAgIENhY2hlLk5PREVfUFJFRklYX1BBVEggPSBDaGlsZFByb2Nlc3Muc3Bhd25TeW5jKG5wbUNvbW1hbmQsIFsnZ2V0JywgJ3ByZWZpeCddLCB7XG4gICAgICAgIGVudjogeyAuLi5wcm9jZXNzLmVudiwgUEFUSDogZ2V0UGF0aCgpIH1cbiAgICAgIH0pLm91dHB1dFsxXS50b1N0cmluZygpLnRyaW0oKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnN0IGVyck1zZyA9ICdVbmFibGUgdG8gZXhlY3V0ZSBgbnBtIGdldCBwcmVmaXhgLiBQbGVhc2UgbWFrZSBzdXJlICdcbiAgICAgICAgKyAnQXRvbSBpcyBnZXR0aW5nICRQQVRIIGNvcnJlY3RseS4nXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyTXNnKVxuICAgIH1cbiAgfVxuICByZXR1cm4gQ2FjaGUuTk9ERV9QUkVGSVhfUEFUSFxufVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSBkaXJQYXRoXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAqL1xuZnVuY3Rpb24gaXNEaXJlY3RvcnkoZGlyUGF0aCkge1xuICBsZXQgaXNEaXJcbiAgdHJ5IHtcbiAgICBpc0RpciA9IGZzLnN0YXRTeW5jKGRpclBhdGgpLmlzRGlyZWN0b3J5KClcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlzRGlyID0gZmFsc2VcbiAgfVxuICByZXR1cm4gaXNEaXJcbn1cblxubGV0IGZhbGxiYWNrRm9yR2xvYmFsRXJyb3JUaHJvd24gPSBmYWxzZVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVzRGlyXG4gKiBAcGFyYW0ge29iamVjdH0gY29uZmlnXG4gKiBAcGFyYW0ge3N0cmluZ30gcHJvamVjdFBhdGhcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gZmFsbGJhY2tGb3JHbG9iYWxcbiAqIEByZXR1cm5zIHt7IHBhdGg6IHN0cmluZywgdHlwZTogJ2xvY2FsIHByb2plY3QnIHwgJ2dsb2JhbCcgfCAnYWR2YW5jZWQgc3BlY2lmaWVkJyB8ICdidW5kbGVkIGZhbGxiYWNrJyB9fVxuICovXG5leHBvcnQgZnVuY3Rpb24gZmluZEVTTGludERpcmVjdG9yeShtb2R1bGVzRGlyLCBjb25maWcsIHByb2plY3RQYXRoLCBmYWxsYmFja0Zvckdsb2JhbCA9IGZhbHNlKSB7XG4gIGxldCBlc2xpbnREaXIgPSBudWxsXG4gIGxldCBsb2NhdGlvblR5cGUgPSBudWxsXG4gIGlmIChjb25maWcuZ2xvYmFsLnVzZUdsb2JhbEVzbGludCAmJiAhZmFsbGJhY2tGb3JHbG9iYWwpIHtcbiAgICBsb2NhdGlvblR5cGUgPSAnZ2xvYmFsJ1xuICAgIGNvbnN0IGNvbmZpZ0dsb2JhbCA9IGNsZWFuUGF0aChjb25maWcuZ2xvYmFsLmdsb2JhbE5vZGVQYXRoKVxuICAgIGNvbnN0IHByZWZpeFBhdGggPSBjb25maWdHbG9iYWwgfHwgZ2V0Tm9kZVByZWZpeFBhdGgoKVxuICAgIC8vIE5QTSBvbiBXaW5kb3dzIGFuZCBZYXJuIG9uIGFsbCBwbGF0Zm9ybXNcbiAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4ocHJlZml4UGF0aCwgJ25vZGVfbW9kdWxlcycsICdlc2xpbnQnKVxuICAgIGlmICghaXNEaXJlY3RvcnkoZXNsaW50RGlyKSkge1xuICAgICAgLy8gTlBNIG9uIHBsYXRmb3JtcyBvdGhlciB0aGFuIFdpbmRvd3NcbiAgICAgIGVzbGludERpciA9IFBhdGguam9pbihwcmVmaXhQYXRoLCAnbGliJywgJ25vZGVfbW9kdWxlcycsICdlc2xpbnQnKVxuICAgIH1cbiAgfSBlbHNlIGlmICghY29uZmlnLmFkdmFuY2VkLmxvY2FsTm9kZU1vZHVsZXMpIHtcbiAgICBsb2NhdGlvblR5cGUgPSAnbG9jYWwgcHJvamVjdCdcbiAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4obW9kdWxlc0RpciB8fCAnJywgJ2VzbGludCcpXG4gIH0gZWxzZSBpZiAoUGF0aC5pc0Fic29sdXRlKGNsZWFuUGF0aChjb25maWcuYWR2YW5jZWQubG9jYWxOb2RlTW9kdWxlcykpKSB7XG4gICAgbG9jYXRpb25UeXBlID0gJ2FkdmFuY2VkIHNwZWNpZmllZCdcbiAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4oY2xlYW5QYXRoKGNvbmZpZy5hZHZhbmNlZC5sb2NhbE5vZGVNb2R1bGVzKSwgJ2VzbGludCcpXG4gIH0gZWxzZSB7XG4gICAgbG9jYXRpb25UeXBlID0gJ2FkdmFuY2VkIHNwZWNpZmllZCdcbiAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4ocHJvamVjdFBhdGggfHwgJycsIGNsZWFuUGF0aChjb25maWcuYWR2YW5jZWQubG9jYWxOb2RlTW9kdWxlcyksICdlc2xpbnQnKVxuICB9XG5cbiAgaWYgKGlzRGlyZWN0b3J5KGVzbGludERpcikpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcGF0aDogZXNsaW50RGlyLFxuICAgICAgdHlwZTogbG9jYXRpb25UeXBlLFxuICAgIH1cbiAgfVxuXG4gIGlmIChjb25maWcuZ2xvYmFsLnVzZUdsb2JhbEVzbGludCAmJiAhZmFsbGJhY2tGb3JHbG9iYWwpIHtcbiAgICBpZiAoIWZhbGxiYWNrRm9yR2xvYmFsRXJyb3JUaHJvd24pIHtcbiAgICAgIC8vIFRocm93IHRoZSBlcnJvciBvbmx5IG9uY2UgdG8gcHJldmVudCBwZXJmb3JtYW5jZSBpc3N1ZXNcbiAgICAgIGZhbGxiYWNrRm9yR2xvYmFsRXJyb3JUaHJvd24gPSB0cnVlXG4gICAgICBjb25zb2xlLmVycm9yKGBHbG9iYWwgRVNMaW50IGlzIG5vdCBmb3VuZCwgZmFsbGluZyBiYWNrIHRvIG90aGVyIEVzbGludCBpbnN0YWxsYXRpb25zLi4uXG4gICAgICAgIFBsZWFzZSBlbnN1cmUgdGhlIGdsb2JhbCBOb2RlIHBhdGggaXMgc2V0IGNvcnJlY3RseS5cbiAgICAgICAgSWYgeW91IHdhbnRlZCB0byB1c2UgYSBsb2NhbCBpbnN0YWxsYXRpb24gb2YgRXNsaW50LCBkaXNhYmxlIEdsb2JhbCBFc2xpbnQgb3B0aW9uIGluIHRoZSBsaW50ZXItZXNsaW50IGNvbmZpZy5gKVxuICAgIH1cbiAgICByZXR1cm4gZmluZEVTTGludERpcmVjdG9yeShtb2R1bGVzRGlyLCBjb25maWcsIHByb2plY3RQYXRoLCB0cnVlKVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBwYXRoOiBDYWNoZS5FU0xJTlRfTE9DQUxfUEFUSCxcbiAgICB0eXBlOiAnYnVuZGxlZCBmYWxsYmFjaycsXG4gIH1cbn1cblxuLyoqXG4gKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlc0RpclxuICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZ1xuICogQHBhcmFtIHtzdHJpbmd9IHByb2plY3RQYXRoXG4gKiBAcmV0dXJucyB7aW1wb3J0KFwiZXNsaW50XCIpfVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RVNMaW50RnJvbURpcmVjdG9yeShtb2R1bGVzRGlyLCBjb25maWcsIHByb2plY3RQYXRoKSB7XG4gIGNvbnN0IHsgcGF0aDogRVNMaW50RGlyZWN0b3J5IH0gPSBmaW5kRVNMaW50RGlyZWN0b3J5KG1vZHVsZXNEaXIsIGNvbmZpZywgcHJvamVjdFBhdGgpXG4gIHRyeSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICByZXR1cm4gcmVxdWlyZShFU0xpbnREaXJlY3RvcnkpXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoY29uZmlnLmdsb2JhbC51c2VHbG9iYWxFc2xpbnQgJiYgZS5jb2RlID09PSAnTU9EVUxFX05PVF9GT1VORCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRVNMaW50IG5vdCBmb3VuZCwgdHJ5IHJlc3RhcnRpbmcgQXRvbSB0byBjbGVhciBjYWNoZXMuJylcbiAgICB9XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICByZXR1cm4gcmVxdWlyZShDYWNoZS5FU0xJTlRfTE9DQUxfUEFUSClcbiAgfVxufVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVzRGlyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWZyZXNoTW9kdWxlc1BhdGgobW9kdWxlc0Rpcikge1xuICBpZiAoQ2FjaGUuTEFTVF9NT0RVTEVTX1BBVEggIT09IG1vZHVsZXNEaXIpIHtcbiAgICBDYWNoZS5MQVNUX01PRFVMRVNfUEFUSCA9IG1vZHVsZXNEaXJcbiAgICBwcm9jZXNzLmVudi5OT0RFX1BBVEggPSBtb2R1bGVzRGlyIHx8ICcnXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgcmVxdWlyZSgnbW9kdWxlJykuTW9kdWxlLl9pbml0UGF0aHMoKVxuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVEaXJcbiAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWdcbiAqIEBwYXJhbSB7c3RyaW5nfSBwcm9qZWN0UGF0aFxuICogQHJldHVybnMge2ltcG9ydChcImVzbGludFwiKX1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEVTTGludEluc3RhbmNlKGZpbGVEaXIsIGNvbmZpZywgcHJvamVjdFBhdGgpIHtcbiAgY29uc3QgbW9kdWxlc0RpciA9IFBhdGguZGlybmFtZShmaW5kQ2FjaGVkKGZpbGVEaXIsICdub2RlX21vZHVsZXMvZXNsaW50JykgfHwgJycpXG4gIHJlZnJlc2hNb2R1bGVzUGF0aChtb2R1bGVzRGlyKVxuICByZXR1cm4gZ2V0RVNMaW50RnJvbURpcmVjdG9yeShtb2R1bGVzRGlyLCBjb25maWcsIHByb2plY3RQYXRoKVxufVxuXG4vKipcbiAqIGNvbnNvbGUubG9nXG4gKiBAcGFyYW0gIHthbnl9IGFyZ3NcbiAqIEByZXR1cm4ge3ZvaWR9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBsb2coLi4uYXJncykge1xuICBjb25zdCBvYmogPSBhcmdzLmxlbmd0aCA9PT0gMSA/IGFyZ3NbMF0gOiBhcmdzXG4gIGxldCBzdHJcbiAgdHJ5IHtcbiAgICBzdHIgPSBKU09OLnN0cmluZ2lmeShvYmopXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBzdHIgPSBVdGlsLmluc3BlY3Qob2JqKVxuICB9XG5cbiAgZW1pdCgnbG9nJywgc3RyKVxufVxuXG4vKipcbiAqIEBwYXJhbSB7aW1wb3J0KFwiZXNsaW50XCIpfSBlc2xpbnRcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q29uZmlnRm9yRmlsZShlc2xpbnQsIGZpbGVQYXRoKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgY2xpID0gbmV3IGVzbGludC5FU0xpbnQoKVxuICAgIHJldHVybiBjbGkuY2FsY3VsYXRlQ29uZmlnRm9yRmlsZShmaWxlUGF0aClcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIGVzbGludCA+PSA3OiBjb25maWcgbm90IGZvdW5kXG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IGNsaSA9IG5ldyBlc2xpbnQuQ0xJRW5naW5lKClcbiAgICByZXR1cm4gY2xpLmdldENvbmZpZ0ZvckZpbGUoZmlsZVBhdGgpXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBlc2xpbnQgPD0gNzogY29uZmlnIG5vdCBmb3VuZFxuICB9XG5cbiAgLy8gTm8gY29uZmlndXJhdGlvbiB3YXMgZm91bmRcbiAgcmV0dXJuIG51bGxcbn1cblxuLyoqXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZURpclxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoXG4gKiBAcGFyYW0ge29iamVjdH0gY29uZmlnXG4gKiBAcGFyYW0ge3N0cmluZ30gcHJvamVjdFBhdGhcbiAqIEByZXR1cm5zIHtzdHJpbmd9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRSZWxhdGl2ZVBhdGgoZmlsZURpciwgZmlsZVBhdGgsIGNvbmZpZywgcHJvamVjdFBhdGgpIHtcbiAgY29uc3QgaWdub3JlRmlsZSA9IGNvbmZpZy5hZHZhbmNlZC5kaXNhYmxlRXNsaW50SWdub3JlID8gbnVsbCA6IGZpbmRDYWNoZWQoZmlsZURpciwgJy5lc2xpbnRpZ25vcmUnKVxuXG4gIC8vIElmIHdlIGNhbiBmaW5kIGFuIC5lc2xpbnRpZ25vcmUgZmlsZSwgd2UgY2FuIHNldCBjd2QgdGhlcmVcbiAgLy8gKGJlY2F1c2UgdGhleSBhcmUgZXhwZWN0ZWQgdG8gYmUgYXQgdGhlIHByb2plY3Qgcm9vdClcbiAgaWYgKGlnbm9yZUZpbGUpIHtcbiAgICBjb25zdCBpZ25vcmVEaXIgPSBQYXRoLmRpcm5hbWUoaWdub3JlRmlsZSlcbiAgICBwcm9jZXNzLmNoZGlyKGlnbm9yZURpcilcbiAgICByZXR1cm4gUGF0aC5yZWxhdGl2ZShpZ25vcmVEaXIsIGZpbGVQYXRoKVxuICB9XG4gIC8vIE90aGVyd2lzZSwgd2UnbGwgc2V0IHRoZSBjd2QgdG8gdGhlIGF0b20gcHJvamVjdCByb290IGFzIGxvbmcgYXMgdGhhdCBleGlzdHNcbiAgaWYgKHByb2plY3RQYXRoKSB7XG4gICAgcHJvY2Vzcy5jaGRpcihwcm9qZWN0UGF0aClcbiAgICByZXR1cm4gUGF0aC5yZWxhdGl2ZShwcm9qZWN0UGF0aCwgZmlsZVBhdGgpXG4gIH1cbiAgLy8gSWYgYWxsIGVsc2UgZmFpbHMsIHVzZSB0aGUgZmlsZSBsb2NhdGlvbiBpdHNlbGZcbiAgcHJvY2Vzcy5jaGRpcihmaWxlRGlyKVxuICByZXR1cm4gUGF0aC5iYXNlbmFtZShmaWxlUGF0aClcbn1cblxuLyoqXG4gKiBAcGFyYW0ge29iamVjdH0gY29uZmlnXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZVBhdGhcbiAqL1xuZnVuY3Rpb24gZ2V0UnVsZVBhdGhzKGNvbmZpZywgZmlsZVBhdGgpIHtcbiAgcmV0dXJuIGNvbmZpZy5hZHZhbmNlZC5lc2xpbnRSdWxlc0RpcnNcbiAgICAubWFwKChwYXRoKSA9PiB7XG4gICAgICBjb25zdCBydWxlc0RpciA9IGNsZWFuUGF0aChwYXRoKVxuICAgICAgaWYgKCFQYXRoLmlzQWJzb2x1dGUocnVsZXNEaXIpKSB7XG4gICAgICAgIHJldHVybiBmaW5kQ2FjaGVkKFBhdGguZGlybmFtZShmaWxlUGF0aCksIHJ1bGVzRGlyKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJ1bGVzRGlyXG4gICAgfSlcbiAgICAuZmlsdGVyKChwYXRoKSA9PiBwYXRoKVxufVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXG4gKiBAcGFyYW0ge3N0cmluZ1tdfSBydWxlc1xuICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZ1xuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoXG4gKiBAcGFyYW0ge29iamVjdH0gZmlsZUNvbmZpZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q0xJRW5naW5lT3B0aW9ucyh0eXBlLCBjb25maWcsIHJ1bGVzLCBmaWxlUGF0aCwgZmlsZUNvbmZpZykge1xuICBjb25zdCBjbGlFbmdpbmVDb25maWcgPSB7XG4gICAgcnVsZXMsXG4gICAgcnVsZVBhdGhzOiBnZXRSdWxlUGF0aHMoY29uZmlnLCBmaWxlUGF0aCksXG4gICAgaWdub3JlOiAhY29uZmlnLmFkdmFuY2VkLmRpc2FibGVFc2xpbnRJZ25vcmUsXG4gICAgZml4OiB0eXBlID09PSAnZml4J1xuICB9XG5cbiAgaWYgKGZpbGVDb25maWcgPT09IG51bGwgJiYgY29uZmlnLmdsb2JhbC5lc2xpbnRyY1BhdGgpIHtcbiAgICAvLyBJZiB3ZSBkaWRuJ3QgZmluZCBhIGNvbmZpZ3VyYXRpb24gdXNlIHRoZSBmYWxsYmFjayBmcm9tIHRoZSBzZXR0aW5nc1xuICAgIGNsaUVuZ2luZUNvbmZpZy5jb25maWdGaWxlID0gY2xlYW5QYXRoKGNvbmZpZy5nbG9iYWwuZXNsaW50cmNQYXRoKVxuICB9XG5cbiAgcmV0dXJuIGNsaUVuZ2luZUNvbmZpZ1xufVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXG4gKiBAcGFyYW0ge3N0cmluZ1tdfSBydWxlc1xuICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZ1xuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoXG4gKiBAcGFyYW0ge29iamVjdH0gZmlsZUNvbmZpZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RVNMaW50T3B0aW9ucyh0eXBlLCBjb25maWcsIHJ1bGVzLCBmaWxlUGF0aCwgZmlsZUNvbmZpZykge1xuICBjb25zdCBlc2xpbnRDb25maWcgPSB7XG4gICAgb3ZlcnJpZGVDb25maWc6IHsgcnVsZXMgfSxcbiAgICBydWxlUGF0aHM6IGdldFJ1bGVQYXRocyhjb25maWcsIGZpbGVQYXRoKSxcbiAgICBpZ25vcmU6ICFjb25maWcuYWR2YW5jZWQuZGlzYWJsZUVzbGludElnbm9yZSxcbiAgICBmaXg6IHR5cGUgPT09ICdmaXgnXG4gIH1cblxuICBpZiAoZmlsZUNvbmZpZyA9PT0gbnVsbCAmJiBjb25maWcuZ2xvYmFsLmVzbGludHJjUGF0aCkge1xuICAgIC8vIElmIHdlIGRpZG4ndCBmaW5kIGEgY29uZmlndXJhdGlvbiB1c2UgdGhlIGZhbGxiYWNrIGZyb20gdGhlIHNldHRpbmdzXG4gICAgZXNsaW50Q29uZmlnLm92ZXJyaWRlQ29uZmlnRmlsZSA9IGNsZWFuUGF0aChjb25maWcuZ2xvYmFsLmVzbGludHJjUGF0aClcbiAgfVxuXG4gIHJldHVybiBlc2xpbnRDb25maWdcbn1cblxuLyoqXG4gKiBHZXRzIHRoZSBsaXN0IG9mIHJ1bGVzIHVzZWQgZm9yIGEgbGludCBqb2JcbiAqIEBwYXJhbSAge2ltcG9ydChcImVzbGludFwiKS5DTElFbmdpbmV9IGVuZ2luZSBUaGUgQ0xJRW5naW5lIGluc3RhbmNlIHVzZWQgZm9yIHRoZSBsaW50IGpvYlxuICogQHJldHVybiB7TWFwfSAgICAgICAgICAgICAgQSBNYXAgb2YgdGhlIHJ1bGVzIHVzZWQsIHJ1bGUgbmFtZXMgYXMga2V5cywgcnVsZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcyBhcyB0aGUgY29udGVudHMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDTElFbmdpbmVSdWxlcyhlbmdpbmUpIHtcbiAgLy8gZXNsaW50IDw9IDc6IFB1bGwgdGhlIGxpc3Qgb2YgcnVsZXMgdXNlZCBkaXJlY3RseSBmcm9tIHRoZSBDTElFbmdpbmVcbiAgaWYgKHR5cGVvZiBlbmdpbmUuZ2V0UnVsZXMgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gZW5naW5lLmdldFJ1bGVzKClcbiAgfVxuXG4gIC8vIEF0dGVtcHQgdG8gdXNlIHRoZSBpbnRlcm5hbCAodW5kb2N1bWVudGVkKSBgbGludGVyYCBpbnN0YW5jZSBhdHRhY2hlZCB0b1xuICAvLyB0aGUgQ0xJRW5naW5lIHRvIGdldCB0aGUgbG9hZGVkIHJ1bGVzIChpbmNsdWRpbmcgcGx1Z2luIHJ1bGVzKS5cbiAgLy8gQWRkZWQgaW4gRVNMaW50IHY0XG4gIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZW5naW5lLCAnbGludGVyJykpIHtcbiAgICByZXR1cm4gZW5naW5lLmxpbnRlci5nZXRSdWxlcygpXG4gIH1cblxuICAvLyBPbGRlciB2ZXJzaW9ucyBvZiBFU0xpbnQgZG9uJ3QgKGVhc2lseSkgc3VwcG9ydCBnZXR0aW5nIGEgbGlzdCBvZiBydWxlc1xuICByZXR1cm4gbmV3IE1hcCgpXG59XG5cbi8qKlxuICogR2V0cyB0aGUgbGlzdCBvZiBydWxlcyB1c2VkIGZvciBhIGxpbnQgam9iXG4gKiBAcGFyYW0gIHtpbXBvcnQoXCJlc2xpbnRcIikuRVNMaW50fSBlbmdpbmUgVGhlIEVTTGludCBpbnN0YW5jZSB1c2VkIGZvciB0aGUgbGludCBqb2JcbiAqIEByZXR1cm4ge1Byb21pc2U8TWFwPn0gICAgICAgICAgICAgIEEgTWFwIG9mIHRoZSBydWxlcyB1c2VkLCBydWxlIG5hbWVzIGFzIGtleXMsIHJ1bGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXMgYXMgdGhlIGNvbnRlbnRzLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RVNMaW50UnVsZXMoZW5naW5lLCB7IGZpbGVQYXRoIH0pIHtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBlbmdpbmUuY2FsY3VsYXRlQ29uZmlnRm9yRmlsZShmaWxlUGF0aClcblxuICByZXR1cm4gbmV3IE1hcChPYmplY3QuZW50cmllcyhyZXNwb25zZS5ydWxlcykpXG59XG5cbi8qKlxuICogR2l2ZW4gYW4gZXhpdGluZyBydWxlIGxpc3QgYW5kIGEgbmV3IHJ1bGUgbGlzdCwgZGV0ZXJtaW5lcyB3aGV0aGVyIHRoZXJlXG4gKiBoYXZlIGJlZW4gY2hhbmdlcy5cbiAqIE5PVEU6IFRoaXMgb25seSBhY2NvdW50cyBmb3IgcHJlc2VuY2Ugb2YgdGhlIHJ1bGVzLCBjaGFuZ2VzIHRvIHRoZWlyIG1ldGFkYXRhXG4gKiBhcmUgbm90IHRha2VuIGludG8gYWNjb3VudC5cbiAqIEBwYXJhbSAge01hcH0gbmV3UnVsZXMgICAgIEEgTWFwIG9mIHRoZSBuZXcgcnVsZXNcbiAqIEBwYXJhbSAge01hcH0gY3VycmVudFJ1bGVzIEEgTWFwIG9mIHRoZSBjdXJyZW50IHJ1bGVzXG4gKiBAcmV0dXJuIHtib29sZWFufSAgICAgICAgICAgICBXaGV0aGVyIG9yIG5vdCB0aGVyZSB3ZXJlIGNoYW5nZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRpZFJ1bGVzQ2hhbmdlKGN1cnJlbnRSdWxlcywgbmV3UnVsZXMpIHtcbiAgcmV0dXJuICEoY3VycmVudFJ1bGVzLnNpemUgPT09IG5ld1J1bGVzLnNpemVcbiAgICAmJiBBcnJheS5mcm9tKGN1cnJlbnRSdWxlcy5rZXlzKCkpLmV2ZXJ5KChydWxlSWQpID0+IG5ld1J1bGVzLmhhcyhydWxlSWQpKSlcbn1cbiJdfQ==