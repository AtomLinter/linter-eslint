"use strict";

var Path = _interopRequireWildcard(require("path"));

var _atomLinter = require("atom-linter");

var Helpers = _interopRequireWildcard(require("./worker-helpers"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/* global emit */
process.title = 'linter-eslint helper';
const rulesMetadata = new Map();
let shouldSendRules = false;
/**
 * The return of {getCLIEngineOptions} function
 * @typedef {object} CliEngineOptions
 * @property {string[]} rules
 * @property {boolean} ignore
 * @property {boolean} fix
 * @property {string[]} rulePaths
 * @property {string | undefined} configFile
 */

/**
 * @param {import("eslint")} eslint
 * @param {CliEngineOptions} cliEngineOptions
 * @param {string} contents
 * @param {string} filePath
 */

function lintJobCLIEngine(eslint, cliEngineOptions, contents, filePath) {
  const cliEngine = new eslint.CLIEngine(cliEngineOptions);
  const report = cliEngine.executeOnText(contents, filePath);
  const rules = Helpers.getCLIEngineRules(cliEngine);
  shouldSendRules = Helpers.didRulesChange(rulesMetadata, rules);

  if (shouldSendRules) {
    // Rebuild rulesMetadata
    rulesMetadata.clear();
    rules.forEach((properties, rule) => rulesMetadata.set(rule, properties));
  }

  return report;
}
/**
 * @param {import("eslint")} eslint
 * @param {CliEngineOptions} cliEngineOptions
 * @param {string} contents
 * @param {string} filePath
 */


function fixJobCLIEngine(eslint, cliEngineOptions, contents, filePath) {
  const report = lintJobCLIEngine(eslint, cliEngineOptions, contents, filePath);
  eslint.CLIEngine.outputFixes(report);

  if (!report.results.length || !report.results[0].messages.length) {
    return 'Linter-ESLint: Fix complete.';
  }

  return 'Linter-ESLint: Fix attempt complete, but linting errors remain.';
}
/**
 * @param {string} type
 * @param {import("eslint")} eslint
 * @param {CliEngineOptions} cliEngineOptions
 * @param {string} contents
 * @param {string} filePath
 */


function executeCLIEngine(type, eslint, cliEngineOptions, contents, filePath) {
  if (type === 'lint') {
    const report = lintJobCLIEngine(eslint, cliEngineOptions, contents, filePath);
    return {
      messages: report.results.length ? report.results[0].messages : [],
      updatedRules: shouldSendRules ? Array.from(rulesMetadata) : undefined
    };
  }

  if (type === 'fix') {
    return fixJobCLIEngine(eslint, cliEngineOptions, contents, filePath);
  }

  return undefined;
}
/**
* The return of {getESLintOptions} function
* @typedef {object} ESLintOptions
* @property {object} overrideConfig
* @property {string[]} overrideConfig.rules
* @property {boolean} ignore
* @property {boolean} fix
* @property {string[]} rulePaths
* @property {string | undefined} overrideConfigFile
*/

/**
 * @param {import("eslint")} eslint
 * @param {ESLintOptions} eslintOptions
 * @param {string} contents
 * @param {string} filePath
 */


async function lintJobESLint(eslint, eslintOptions, contents, filePath) {
  const linter = new eslint.ESLint(eslintOptions);
  const report = await linter.lintText(contents, {
    filePath
  });
  const rules = await Helpers.getESLintRules(linter, {
    filePath
  });
  shouldSendRules = Helpers.didRulesChange(rulesMetadata, rules);

  if (shouldSendRules) {
    // Rebuild rulesMetadata
    rulesMetadata.clear();
    rules.forEach((properties, rule) => rulesMetadata.set(rule, properties));
  }

  return report;
}
/**
 * @param {import("eslint")} eslint
 * @param {ESLintOptions} eslintOptions
 * @param {string} contents
 * @param {string} filePath
 */


async function fixJobESLint(eslint, eslintOptions, contents, filePath) {
  const report = await lintJobESLint(eslint, eslintOptions, contents, filePath);
  eslint.ESLint.outputFixes(report);

  if (!report.length || !report[0].messages.length) {
    return 'Linter-ESLint: Fix complete.';
  }

  return 'Linter-ESLint: Fix attempt complete, but linting errors remain.';
}
/**
 * @param {string} type
 * @param {import("eslint")} eslint
 * @param {ESLintOptions} eslintOptions
 * @param {string} contents
 * @param {string} filePath
 */


async function executeESLint(type, eslint, eslintOptions, contents, filePath) {
  if (type === 'lint') {
    const report = await lintJobESLint(eslint, eslintOptions, contents, filePath);
    return {
      messages: report.length ? report[0].messages : [],
      updatedRules: shouldSendRules ? Array.from(rulesMetadata) : undefined
    };
  }

  if (type === 'fix') {
    return fixJobESLint(eslint, eslintOptions, contents, filePath);
  }

  return undefined;
}

module.exports = async () => {
  process.on('message', async jobConfig => {
    // We catch all worker errors so that we can create a separate error emitter
    // for each emitKey, rather than adding multiple listeners for `task:error`
    const {
      contents,
      type,
      config,
      filePath,
      projectPath,
      rules,
      emitKey
    } = jobConfig;

    try {
      if (config.advanced.disableFSCache) {
        _atomLinter.FindCache.clear();
      }

      const fileDir = Path.dirname(filePath);
      const eslint = Helpers.getESLintInstance(fileDir, config, projectPath);
      const fileConfig = await Helpers.getConfigForFile(eslint, filePath);

      if (fileConfig === null && config.disabling.disableWhenNoEslintConfig) {
        emit(emitKey, {
          messages: []
        });
        return;
      }

      const relativeFilePath = Helpers.getRelativePath(fileDir, filePath, config, projectPath);
      let response;

      if (type === 'debug') {
        const modulesDir = Path.dirname((0, _atomLinter.findCached)(fileDir, 'node_modules/eslint') || '');
        response = Helpers.findESLintDirectory(modulesDir, config, projectPath);
      } else if (eslint.ESLint) {
        const eslintOptions = Helpers.getESLintOptions(type, config, rules, relativeFilePath, fileConfig);
        response = await executeESLint(type, eslint, eslintOptions, contents, filePath);
      } else if (eslint.CLIEngine) {
        const cliEngineOptions = Helpers.getCLIEngineOptions(type, config, rules, relativeFilePath, fileConfig);
        response = executeCLIEngine(type, eslint, cliEngineOptions, contents, filePath);
      }

      emit(emitKey, response);
    } catch (workerErr) {
      emit(`workerError:${emitKey}`, {
        msg: workerErr.message,
        stack: workerErr.stack
      });
    }
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93b3JrZXIuanMiXSwibmFtZXMiOlsicHJvY2VzcyIsInRpdGxlIiwicnVsZXNNZXRhZGF0YSIsIk1hcCIsInNob3VsZFNlbmRSdWxlcyIsImxpbnRKb2JDTElFbmdpbmUiLCJlc2xpbnQiLCJjbGlFbmdpbmVPcHRpb25zIiwiY29udGVudHMiLCJmaWxlUGF0aCIsImNsaUVuZ2luZSIsIkNMSUVuZ2luZSIsInJlcG9ydCIsImV4ZWN1dGVPblRleHQiLCJydWxlcyIsIkhlbHBlcnMiLCJnZXRDTElFbmdpbmVSdWxlcyIsImRpZFJ1bGVzQ2hhbmdlIiwiY2xlYXIiLCJmb3JFYWNoIiwicHJvcGVydGllcyIsInJ1bGUiLCJzZXQiLCJmaXhKb2JDTElFbmdpbmUiLCJvdXRwdXRGaXhlcyIsInJlc3VsdHMiLCJsZW5ndGgiLCJtZXNzYWdlcyIsImV4ZWN1dGVDTElFbmdpbmUiLCJ0eXBlIiwidXBkYXRlZFJ1bGVzIiwiQXJyYXkiLCJmcm9tIiwidW5kZWZpbmVkIiwibGludEpvYkVTTGludCIsImVzbGludE9wdGlvbnMiLCJsaW50ZXIiLCJFU0xpbnQiLCJsaW50VGV4dCIsImdldEVTTGludFJ1bGVzIiwiZml4Sm9iRVNMaW50IiwiZXhlY3V0ZUVTTGludCIsIm1vZHVsZSIsImV4cG9ydHMiLCJvbiIsImpvYkNvbmZpZyIsImNvbmZpZyIsInByb2plY3RQYXRoIiwiZW1pdEtleSIsImFkdmFuY2VkIiwiZGlzYWJsZUZTQ2FjaGUiLCJGaW5kQ2FjaGUiLCJmaWxlRGlyIiwiUGF0aCIsImRpcm5hbWUiLCJnZXRFU0xpbnRJbnN0YW5jZSIsImZpbGVDb25maWciLCJnZXRDb25maWdGb3JGaWxlIiwiZGlzYWJsaW5nIiwiZGlzYWJsZVdoZW5Ob0VzbGludENvbmZpZyIsImVtaXQiLCJyZWxhdGl2ZUZpbGVQYXRoIiwiZ2V0UmVsYXRpdmVQYXRoIiwicmVzcG9uc2UiLCJtb2R1bGVzRGlyIiwiZmluZEVTTGludERpcmVjdG9yeSIsImdldEVTTGludE9wdGlv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LEVBQWdEQyxXQUFoRCxDQUFYO0FBQ0QsT0FIRCxNQUtBLElBQUl6QyxNQUFNLENBQUMrQixNQUFYLEVBQW1CO0FBQ2pCLGNBQU1GLGFBQWEsR0FBR3BCLE9BQU8sQ0FBQ21ELGdCQUFSLENBQXlCckMsSUFBekIsRUFBK0JpQixNQUEvQixFQUF1Q2hDLEtBQXZDLEVBQThDK0MsZ0JBQTlDLEVBQWdFTCxVQUFoRSxDQUF0QjtBQUNBTyxRQUFBQSxRQUFRLEdBQUcsTUFBTXRCLGFBQWEsQ0FBQ1osSUFBRCxFQUFPdkIsTUFBUCxFQUFlNkIsYUFBZixFQUE4QjNCLFFBQTlCLEVBQXdDQyxRQUF4QyxDQUE5QjtBQUNELE9BSEQsTUFLQSxJQUFJSCxNQUFNLENBQUNLLFNBQVgsRUFBc0I7QUFDcEIsY0FBTUosZ0JBQWdCLEdBQUdRLE9BQU8sQ0FBQ29ELG1CQUFSLENBQTRCdEMsSUFBNUIsRUFBa0NpQixNQUFsQyxFQUEwQ2hDLEtBQTFDLEVBQWlEK0MsZ0JBQWpELEVBQW1FTCxVQUFuRSxDQUF6QjtBQUNBTyxRQUFBQSxRQUFRLEdBQUduQyxnQkFBZ0IsQ0FBQ0MsSUFBRCxFQUFPdkIsTUFBUCxFQUFlQyxnQkFBZixFQUFpQ0MsUUFBakMsRUFBMkNDLFFBQTNDLENBQTNCO0FBQ0Q7O0FBRURtRCxNQUFBQSxJQUFJLENBQUNaLE9BQUQsRUFBVWUsUUFBVixDQUFKO0FBQ0QsS0FqQ0QsQ0FpQ0UsT0FBT0ssU0FBUCxFQUFrQjtBQUNsQlIsTUFBQUEsSUFBSSxDQUFFLGVBQWNaLE9BQVEsRUFBeEIsRUFBMkI7QUFBRXFCLFFBQUFBLEdBQUcsRUFBRUQsU0FBUyxDQUFDRSxPQUFqQjtBQUEwQkMsUUFBQUEsS0FBSyxFQUFFSCxTQUFTLENBQUNHO0FBQTNDLE9BQTNCLENBQUo7QUFDRDtBQUNGLEdBMUNEO0FBMkNELENBNUNEIiwic291cmNlc0NvbnRlbnQiOlsiLyogZ2xvYmFsIGVtaXQgKi9cblxuaW1wb3J0ICogYXMgUGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgRmluZENhY2hlLCBmaW5kQ2FjaGVkIH0gZnJvbSAnYXRvbS1saW50ZXInXG5pbXBvcnQgKiBhcyBIZWxwZXJzIGZyb20gJy4vd29ya2VyLWhlbHBlcnMnXG5cbnByb2Nlc3MudGl0bGUgPSAnbGludGVyLWVzbGludCBoZWxwZXInXG5cbmNvbnN0IHJ1bGVzTWV0YWRhdGEgPSBuZXcgTWFwKClcbmxldCBzaG91bGRTZW5kUnVsZXMgPSBmYWxzZVxuXG4vKipcbiAqIFRoZSByZXR1cm4gb2Yge2dldENMSUVuZ2luZU9wdGlvbnN9IGZ1bmN0aW9uXG4gKiBAdHlwZWRlZiB7b2JqZWN0fSBDbGlFbmdpbmVPcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ1tdfSBydWxlc1xuICogQHByb3BlcnR5IHtib29sZWFufSBpZ25vcmVcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZml4XG4gKiBAcHJvcGVydHkge3N0cmluZ1tdfSBydWxlUGF0aHNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nIHwgdW5kZWZpbmVkfSBjb25maWdGaWxlXG4gKi9cblxuLyoqXG4gKiBAcGFyYW0ge2ltcG9ydChcImVzbGludFwiKX0gZXNsaW50XG4gKiBAcGFyYW0ge0NsaUVuZ2luZU9wdGlvbnN9IGNsaUVuZ2luZU9wdGlvbnNcbiAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZW50c1xuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoXG4gKi9cbmZ1bmN0aW9uIGxpbnRKb2JDTElFbmdpbmUoZXNsaW50LCBjbGlFbmdpbmVPcHRpb25zLCBjb250ZW50cywgZmlsZVBhdGgpIHtcbiAgY29uc3QgY2xpRW5naW5lID0gbmV3IGVzbGludC5DTElFbmdpbmUoY2xpRW5naW5lT3B0aW9ucylcbiAgY29uc3QgcmVwb3J0ID0gY2xpRW5naW5lLmV4ZWN1dGVPblRleHQoY29udGVudHMsIGZpbGVQYXRoKVxuICBjb25zdCBydWxlcyA9IEhlbHBlcnMuZ2V0Q0xJRW5naW5lUnVsZXMoY2xpRW5naW5lKVxuXG4gIHNob3VsZFNlbmRSdWxlcyA9IEhlbHBlcnMuZGlkUnVsZXNDaGFuZ2UocnVsZXNNZXRhZGF0YSwgcnVsZXMpXG4gIGlmIChzaG91bGRTZW5kUnVsZXMpIHtcbiAgICAvLyBSZWJ1aWxkIHJ1bGVzTWV0YWRhdGFcbiAgICBydWxlc01ldGFkYXRhLmNsZWFyKClcbiAgICBydWxlcy5mb3JFYWNoKChwcm9wZXJ0aWVzLCBydWxlKSA9PiBydWxlc01ldGFkYXRhLnNldChydWxlLCBwcm9wZXJ0aWVzKSlcbiAgfVxuICByZXR1cm4gcmVwb3J0XG59XG5cbi8qKlxuICogQHBhcmFtIHtpbXBvcnQoXCJlc2xpbnRcIil9IGVzbGludFxuICogQHBhcmFtIHtDbGlFbmdpbmVPcHRpb25zfSBjbGlFbmdpbmVPcHRpb25zXG4gKiBAcGFyYW0ge3N0cmluZ30gY29udGVudHNcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aFxuICovXG5mdW5jdGlvbiBmaXhKb2JDTElFbmdpbmUoZXNsaW50LCBjbGlFbmdpbmVPcHRpb25zLCBjb250ZW50cywgZmlsZVBhdGgpIHtcbiAgY29uc3QgcmVwb3J0ID0gbGludEpvYkNMSUVuZ2luZShlc2xpbnQsIGNsaUVuZ2luZU9wdGlvbnMsIGNvbnRlbnRzLCBmaWxlUGF0aClcblxuICBlc2xpbnQuQ0xJRW5naW5lLm91dHB1dEZpeGVzKHJlcG9ydClcblxuICBpZiAoIXJlcG9ydC5yZXN1bHRzLmxlbmd0aCB8fCAhcmVwb3J0LnJlc3VsdHNbMF0ubWVzc2FnZXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuICdMaW50ZXItRVNMaW50OiBGaXggY29tcGxldGUuJ1xuICB9XG4gIHJldHVybiAnTGludGVyLUVTTGludDogRml4IGF0dGVtcHQgY29tcGxldGUsIGJ1dCBsaW50aW5nIGVycm9ycyByZW1haW4uJ1xufVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXG4gKiBAcGFyYW0ge2ltcG9ydChcImVzbGludFwiKX0gZXNsaW50XG4gKiBAcGFyYW0ge0NsaUVuZ2luZU9wdGlvbnN9IGNsaUVuZ2luZU9wdGlvbnNcbiAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZW50c1xuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoXG4gKi9cbmZ1bmN0aW9uIGV4ZWN1dGVDTElFbmdpbmUodHlwZSwgZXNsaW50LCBjbGlFbmdpbmVPcHRpb25zLCBjb250ZW50cywgZmlsZVBhdGgpIHtcbiAgaWYgKHR5cGUgPT09ICdsaW50Jykge1xuICAgIGNvbnN0IHJlcG9ydCA9IGxpbnRKb2JDTElFbmdpbmUoZXNsaW50LCBjbGlFbmdpbmVPcHRpb25zLCBjb250ZW50cywgZmlsZVBhdGgpXG4gICAgcmV0dXJuIHtcbiAgICAgIG1lc3NhZ2VzOiByZXBvcnQucmVzdWx0cy5sZW5ndGggPyByZXBvcnQucmVzdWx0c1swXS5tZXNzYWdlcyA6IFtdLFxuICAgICAgdXBkYXRlZFJ1bGVzOiBzaG91bGRTZW5kUnVsZXMgPyBBcnJheS5mcm9tKHJ1bGVzTWV0YWRhdGEpIDogdW5kZWZpbmVkXG4gICAgfVxuICB9XG5cbiAgaWYgKHR5cGUgPT09ICdmaXgnKSB7XG4gICAgcmV0dXJuIGZpeEpvYkNMSUVuZ2luZShlc2xpbnQsIGNsaUVuZ2luZU9wdGlvbnMsIGNvbnRlbnRzLCBmaWxlUGF0aClcbiAgfVxuXG4gIHJldHVybiB1bmRlZmluZWRcbn1cblxuLyoqXG4qIFRoZSByZXR1cm4gb2Yge2dldEVTTGludE9wdGlvbnN9IGZ1bmN0aW9uXG4qIEB0eXBlZGVmIHtvYmplY3R9IEVTTGludE9wdGlvbnNcbiogQHByb3BlcnR5IHtvYmplY3R9IG92ZXJyaWRlQ29uZmlnXG4qIEBwcm9wZXJ0eSB7c3RyaW5nW119IG92ZXJyaWRlQ29uZmlnLnJ1bGVzXG4qIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaWdub3JlXG4qIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZml4XG4qIEBwcm9wZXJ0eSB7c3RyaW5nW119IHJ1bGVQYXRoc1xuKiBAcHJvcGVydHkge3N0cmluZyB8IHVuZGVmaW5lZH0gb3ZlcnJpZGVDb25maWdGaWxlXG4qL1xuXG4vKipcbiAqIEBwYXJhbSB7aW1wb3J0KFwiZXNsaW50XCIpfSBlc2xpbnRcbiAqIEBwYXJhbSB7RVNMaW50T3B0aW9uc30gZXNsaW50T3B0aW9uc1xuICogQHBhcmFtIHtzdHJpbmd9IGNvbnRlbnRzXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZVBhdGhcbiAqL1xuYXN5bmMgZnVuY3Rpb24gbGludEpvYkVTTGludChlc2xpbnQsIGVzbGludE9wdGlvbnMsIGNvbnRlbnRzLCBmaWxlUGF0aCkge1xuICBjb25zdCBsaW50ZXIgPSBuZXcgZXNsaW50LkVTTGludChlc2xpbnRPcHRpb25zKVxuICBjb25zdCByZXBvcnQgPSBhd2FpdCBsaW50ZXIubGludFRleHQoY29udGVudHMsIHsgZmlsZVBhdGggfSlcbiAgY29uc3QgcnVsZXMgPSBhd2FpdCBIZWxwZXJzLmdldEVTTGludFJ1bGVzKGxpbnRlciwgeyBmaWxlUGF0aCB9KVxuXG4gIHNob3VsZFNlbmRSdWxlcyA9IEhlbHBlcnMuZGlkUnVsZXNDaGFuZ2UocnVsZXNNZXRhZGF0YSwgcnVsZXMpXG4gIGlmIChzaG91bGRTZW5kUnVsZXMpIHtcbiAgICAvLyBSZWJ1aWxkIHJ1bGVzTWV0YWRhdGFcbiAgICBydWxlc01ldGFkYXRhLmNsZWFyKClcbiAgICBydWxlcy5mb3JFYWNoKChwcm9wZXJ0aWVzLCBydWxlKSA9PiBydWxlc01ldGFkYXRhLnNldChydWxlLCBwcm9wZXJ0aWVzKSlcbiAgfVxuICByZXR1cm4gcmVwb3J0XG59XG5cbi8qKlxuICogQHBhcmFtIHtpbXBvcnQoXCJlc2xpbnRcIil9IGVzbGludFxuICogQHBhcmFtIHtFU0xpbnRPcHRpb25zfSBlc2xpbnRPcHRpb25zXG4gKiBAcGFyYW0ge3N0cmluZ30gY29udGVudHNcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aFxuICovXG5hc3luYyBmdW5jdGlvbiBmaXhKb2JFU0xpbnQoZXNsaW50LCBlc2xpbnRPcHRpb25zLCBjb250ZW50cywgZmlsZVBhdGgpIHtcbiAgY29uc3QgcmVwb3J0ID0gYXdhaXQgbGludEpvYkVTTGludChlc2xpbnQsIGVzbGludE9wdGlvbnMsIGNvbnRlbnRzLCBmaWxlUGF0aClcblxuICBlc2xpbnQuRVNMaW50Lm91dHB1dEZpeGVzKHJlcG9ydClcblxuICBpZiAoIXJlcG9ydC5sZW5ndGggfHwgIXJlcG9ydFswXS5tZXNzYWdlcy5sZW5ndGgpIHtcbiAgICByZXR1cm4gJ0xpbnRlci1FU0xpbnQ6IEZpeCBjb21wbGV0ZS4nXG4gIH1cbiAgcmV0dXJuICdMaW50ZXItRVNMaW50OiBGaXggYXR0ZW1wdCBjb21wbGV0ZSwgYnV0IGxpbnRpbmcgZXJyb3JzIHJlbWFpbi4nXG59XG5cbi8qKlxuICogQHBhcmFtIHtzdHJpbmd9IHR5cGVcbiAqIEBwYXJhbSB7aW1wb3J0KFwiZXNsaW50XCIpfSBlc2xpbnRcbiAqIEBwYXJhbSB7RVNMaW50T3B0aW9uc30gZXNsaW50T3B0aW9uc1xuICogQHBhcmFtIHtzdHJpbmd9IGNvbnRlbnRzXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZVBhdGhcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZUVTTGludCh0eXBlLCBlc2xpbnQsIGVzbGludE9wdGlvbnMsIGNvbnRlbnRzLCBmaWxlUGF0aCkge1xuICBpZiAodHlwZSA9PT0gJ2xpbnQnKSB7XG4gICAgY29uc3QgcmVwb3J0ID0gYXdhaXQgbGludEpvYkVTTGludChlc2xpbnQsIGVzbGludE9wdGlvbnMsIGNvbnRlbnRzLCBmaWxlUGF0aClcbiAgICByZXR1cm4ge1xuICAgICAgbWVzc2FnZXM6IHJlcG9ydC5sZW5ndGggPyByZXBvcnRbMF0ubWVzc2FnZXMgOiBbXSxcbiAgICAgIHVwZGF0ZWRSdWxlczogc2hvdWxkU2VuZFJ1bGVzID8gQXJyYXkuZnJvbShydWxlc01ldGFkYXRhKSA6IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIGlmICh0eXBlID09PSAnZml4Jykge1xuICAgIHJldHVybiBmaXhKb2JFU0xpbnQoZXNsaW50LCBlc2xpbnRPcHRpb25zLCBjb250ZW50cywgZmlsZVBhdGgpXG4gIH1cblxuICByZXR1cm4gdW5kZWZpbmVkXG59XG5cbm1vZHVsZS5leHBvcnRzID0gYXN5bmMgKCkgPT4ge1xuICBwcm9jZXNzLm9uKCdtZXNzYWdlJywgYXN5bmMgKGpvYkNvbmZpZykgPT4ge1xuICAgIC8vIFdlIGNhdGNoIGFsbCB3b3JrZXIgZXJyb3JzIHNvIHRoYXQgd2UgY2FuIGNyZWF0ZSBhIHNlcGFyYXRlIGVycm9yIGVtaXR0ZXJcbiAgICAvLyBmb3IgZWFjaCBlbWl0S2V5LCByYXRoZXIgdGhhbiBhZGRpbmcgbXVsdGlwbGUgbGlzdGVuZXJzIGZvciBgdGFzazplcnJvcmBcbiAgICBjb25zdCB7XG4gICAgICBjb250ZW50cywgdHlwZSwgY29uZmlnLCBmaWxlUGF0aCwgcHJvamVjdFBhdGgsIHJ1bGVzLCBlbWl0S2V5XG4gICAgfSA9IGpvYkNvbmZpZ1xuICAgIHRyeSB7XG4gICAgICBpZiAoY29uZmlnLmFkdmFuY2VkLmRpc2FibGVGU0NhY2hlKSB7XG4gICAgICAgIEZpbmRDYWNoZS5jbGVhcigpXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGZpbGVEaXIgPSBQYXRoLmRpcm5hbWUoZmlsZVBhdGgpXG4gICAgICBjb25zdCBlc2xpbnQgPSBIZWxwZXJzLmdldEVTTGludEluc3RhbmNlKGZpbGVEaXIsIGNvbmZpZywgcHJvamVjdFBhdGgpXG5cbiAgICAgIGNvbnN0IGZpbGVDb25maWcgPSBhd2FpdCBIZWxwZXJzLmdldENvbmZpZ0ZvckZpbGUoZXNsaW50LCBmaWxlUGF0aClcbiAgICAgIGlmIChmaWxlQ29uZmlnID09PSBudWxsICYmIGNvbmZpZy5kaXNhYmxpbmcuZGlzYWJsZVdoZW5Ob0VzbGludENvbmZpZykge1xuICAgICAgICBlbWl0KGVtaXRLZXksIHsgbWVzc2FnZXM6IFtdIH0pXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBjb25zdCByZWxhdGl2ZUZpbGVQYXRoID0gSGVscGVycy5nZXRSZWxhdGl2ZVBhdGgoZmlsZURpciwgZmlsZVBhdGgsIGNvbmZpZywgcHJvamVjdFBhdGgpXG5cbiAgICAgIGxldCByZXNwb25zZVxuICAgICAgaWYgKHR5cGUgPT09ICdkZWJ1ZycpIHtcbiAgICAgICAgY29uc3QgbW9kdWxlc0RpciA9IFBhdGguZGlybmFtZShmaW5kQ2FjaGVkKGZpbGVEaXIsICdub2RlX21vZHVsZXMvZXNsaW50JykgfHwgJycpXG4gICAgICAgIHJlc3BvbnNlID0gSGVscGVycy5maW5kRVNMaW50RGlyZWN0b3J5KG1vZHVsZXNEaXIsIGNvbmZpZywgcHJvamVjdFBhdGgpXG4gICAgICB9IGVsc2VcblxuICAgICAgaWYgKGVzbGludC5FU0xpbnQpIHtcbiAgICAgICAgY29uc3QgZXNsaW50T3B0aW9ucyA9IEhlbHBlcnMuZ2V0RVNMaW50T3B0aW9ucyh0eXBlLCBjb25maWcsIHJ1bGVzLCByZWxhdGl2ZUZpbGVQYXRoLCBmaWxlQ29uZmlnKVxuICAgICAgICByZXNwb25zZSA9IGF3YWl0IGV4ZWN1dGVFU0xpbnQodHlwZSwgZXNsaW50LCBlc2xpbnRPcHRpb25zLCBjb250ZW50cywgZmlsZVBhdGgpXG4gICAgICB9IGVsc2VcblxuICAgICAgaWYgKGVzbGludC5DTElFbmdpbmUpIHtcbiAgICAgICAgY29uc3QgY2xpRW5naW5lT3B0aW9ucyA9IEhlbHBlcnMuZ2V0Q0xJRW5naW5lT3B0aW9ucyh0eXBlLCBjb25maWcsIHJ1bGVzLCByZWxhdGl2ZUZpbGVQYXRoLCBmaWxlQ29uZmlnKVxuICAgICAgICByZXNwb25zZSA9IGV4ZWN1dGVDTElFbmdpbmUodHlwZSwgZXNsaW50LCBjbGlFbmdpbmVPcHRpb25zLCBjb250ZW50cywgZmlsZVBhdGgpXG4gICAgICB9XG5cbiAgICAgIGVtaXQoZW1pdEtleSwgcmVzcG9uc2UpXG4gICAgfSBjYXRjaCAod29ya2VyRXJyKSB7XG4gICAgICBlbWl0KGB3b3JrZXJFcnJvcjoke2VtaXRLZXl9YCwgeyBtc2c6IHdvcmtlckVyci5tZXNzYWdlLCBzdGFjazogd29ya2VyRXJyLnN0YWNrIH0pXG4gICAgfVxuICB9KVxufVxuIl19