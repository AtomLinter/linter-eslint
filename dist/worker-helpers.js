"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getNodePrefixPath = getNodePrefixPath;
exports.findESLintDirectory = findESLintDirectory;
exports.getESLintFromDirectory = getESLintFromDirectory;
exports.refreshModulesPath = refreshModulesPath;
exports.getESLintInstance = getESLintInstance;
exports.log = log;
exports.getConfigForFile = getConfigForFile;
exports.getRelativePath = getRelativePath;
exports.getCLIEngineOptions = getCLIEngineOptions;
exports.getRules = getRules;
exports.didRulesChange = didRulesChange;

var _path = _interopRequireDefault(require("path"));

var _util = _interopRequireDefault(require("util"));

var _fsPlus = _interopRequireDefault(require("fs-plus"));

var _child_process = _interopRequireDefault(require("child_process"));

var _resolveEnv = _interopRequireDefault(require("resolve-env"));

var _atomLinter = require("atom-linter");

var _consistentPath = _interopRequireDefault(require("consistent-path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* global emit */
const Cache = {
  ESLINT_LOCAL_PATH: _path.default.normalize(_path.default.join(__dirname, '..', 'node_modules', 'eslint')),
  NODE_PREFIX_PATH: null,
  LAST_MODULES_PATH: null
};
/**
 * Takes a path and translates `~` to the user's home directory, and replaces
 * all environment variables with their value.
 * @param  {string} path The path to remove "strangeness" from
 * @return {string}      The cleaned path
 */

const cleanPath = path => path ? (0, _resolveEnv.default)(_fsPlus.default.normalize(path)) : '';
/**
 * @returns {string}
 */


function getNodePrefixPath() {
  if (Cache.NODE_PREFIX_PATH === null) {
    const npmCommand = process.platform === 'win32' ? 'npm.cmd' : 'npm';

    try {
      Cache.NODE_PREFIX_PATH = _child_process.default.spawnSync(npmCommand, ['get', 'prefix'], {
        env: Object.assign(Object.assign({}, process.env), {
          PATH: (0, _consistentPath.default)()
        })
      }).output[1].toString().trim();
    } catch (e) {
      const errMsg = 'Unable to execute `npm get prefix`. Please make sure ' + 'Atom is getting $PATH correctly.';
      throw new Error(errMsg);
    }
  }

  return Cache.NODE_PREFIX_PATH;
}
/**
 * @param {string} dirPath
 * @returns {boolean}
 */


function isDirectory(dirPath) {
  let isDir;

  try {
    isDir = _fsPlus.default.statSync(dirPath).isDirectory();
  } catch (e) {
    isDir = false;
  }

  return isDir;
}

let fallbackForGlobalErrorThrown = false;
/**
 * @param {string} modulesDir
 * @param {object} config
 * @param {string} projectPath
 * @param {boolean} fallbackForGlobal
 * @returns {{ path: string, type: 'local project' | 'global' | 'advanced specified' | 'bundled fallback' }}
 */

function findESLintDirectory(modulesDir, config, projectPath, fallbackForGlobal = false) {
  let eslintDir = null;
  let locationType = null;

  if (config.global.useGlobalEslint && !fallbackForGlobal) {
    locationType = 'global';
    const configGlobal = cleanPath(config.global.globalNodePath);
    const prefixPath = configGlobal || getNodePrefixPath(); // NPM on Windows and Yarn on all platforms

    eslintDir = _path.default.join(prefixPath, 'node_modules', 'eslint');

    if (!isDirectory(eslintDir)) {
      // NPM on platforms other than Windows
      eslintDir = _path.default.join(prefixPath, 'lib', 'node_modules', 'eslint');
    }
  } else if (!config.advanced.localNodeModules) {
    locationType = 'local project';
    eslintDir = _path.default.join(modulesDir || '', 'eslint');
  } else if (_path.default.isAbsolute(cleanPath(config.advanced.localNodeModules))) {
    locationType = 'advanced specified';
    eslintDir = _path.default.join(cleanPath(config.advanced.localNodeModules), 'eslint');
  } else {
    locationType = 'advanced specified';
    eslintDir = _path.default.join(projectPath || '', cleanPath(config.advanced.localNodeModules), 'eslint');
  }

  if (isDirectory(eslintDir)) {
    return {
      path: eslintDir,
      type: locationType
    };
  }

  if (config.global.useGlobalEslint && !fallbackForGlobal) {
    if (!fallbackForGlobalErrorThrown) {
      // Throw the error only once to prevent performance issues
      fallbackForGlobalErrorThrown = true;
      console.error(`Global ESLint is not found, falling back to other Eslint installations...
        Please ensure the global Node path is set correctly.
        If you wanted to use a local installation of Eslint, disable Global Eslint option in the linter-eslint config.`);
    }

    return findESLintDirectory(modulesDir, config, projectPath, true);
  }

  return {
    path: Cache.ESLINT_LOCAL_PATH,
    type: 'bundled fallback'
  };
}
/**
 * @param {string} modulesDir
 * @param {object} config
 * @param {string} projectPath
 * @returns {import("eslint")}
 */


function getESLintFromDirectory(modulesDir, config, projectPath) {
  const {
    path: ESLintDirectory
  } = findESLintDirectory(modulesDir, config, projectPath);

  try {
    // eslint-disable-next-line import/no-dynamic-require
    return require(ESLintDirectory);
  } catch (e) {
    if (config.global.useGlobalEslint && e.code === 'MODULE_NOT_FOUND') {
      throw new Error('ESLint not found, try restarting Atom to clear caches.');
    } // eslint-disable-next-line import/no-dynamic-require


    return require(Cache.ESLINT_LOCAL_PATH);
  }
}
/**
 * @param {string} modulesDir
 */


function refreshModulesPath(modulesDir) {
  if (Cache.LAST_MODULES_PATH !== modulesDir) {
    Cache.LAST_MODULES_PATH = modulesDir;
    process.env.NODE_PATH = modulesDir || ''; // eslint-disable-next-line no-underscore-dangle

    require('module').Module._initPaths();
  }
} // export async function getESLintBinary(rootPath) {
//   const platform = process.platform;
//   if (platform === 'win32' && await fs.exists(Path.join(rootPath, 'node_modules', '.bin', 'eslint.cmd'))) {
//     return Path.join('.', 'node_modules', '.bin', 'eslint.cmd');
//   } else if ((platform === 'linux' || platform === 'darwin')
//     && await fs.exists(Path.join(rootPath, 'node_modules', '.bin', 'eslint'))) {
//     return Path.join('.', 'node_modules', '.bin', 'eslint');
//   } else {
//     return 'eslint';
//   }
// }

/**
 * @param {string} fileDir
 * @param {object} config
 * @param {string} projectPath
 * @returns {import("eslint")}
 */


function getESLintInstance(fileDir, config, projectPath) {
  const modulesDir = _path.default.dirname((0, _atomLinter.findCached)(fileDir, 'node_modules/eslint') || '');

  refreshModulesPath(modulesDir);
  return getESLintFromDirectory(modulesDir, config, projectPath);
}
/**
 * console.log
 * @param  {any} args
 * @return {void}
 */


function log(...args) {
  const obj = args.length === 1 ? args[0] : args;
  let str;

  try {
    str = JSON.stringify(obj);
  } catch (e) {
    str = _util.default.inspect(obj);
  }

  emit('log', str);
}
/**
 * @param {import("eslint")} eslint
 * @param {string} filePath
 */


function getConfigForFile(eslint, filePath) {
  const cli = new eslint.CLIEngine();

  try {
    return cli.getConfigForFile(filePath);
  } catch (e) {
    // No configuration was found
    return null;
  }
}
/**
 * @param {string} fileDir
 * @param {string} filePath
 * @param {object} config
 * @param {string} projectPath
 * @returns {string}
 */


function getRelativePath(fileDir, filePath, config, projectPath) {
  const ignoreFile = config.advanced.disableEslintIgnore ? null : (0, _atomLinter.findCached)(fileDir, '.eslintignore'); // If we can find an .eslintignore file, we can set cwd there
  // (because they are expected to be at the project root)

  if (ignoreFile) {
    const ignoreDir = _path.default.dirname(ignoreFile);

    process.chdir(ignoreDir);
    return _path.default.relative(ignoreDir, filePath);
  } // Otherwise, we'll set the cwd to the atom project root as long as that exists


  if (projectPath) {
    process.chdir(projectPath);
    return _path.default.relative(projectPath, filePath);
  } // If all else fails, use the file location itself


  process.chdir(fileDir);
  return _path.default.basename(filePath);
}
/**
 * @param {string} type
 * @param {string[]} rules
 * @param {object} config
 * @param {string} filePath
 * @param {object} fileConfig
 */


function getCLIEngineOptions(type, config, rules, filePath, fileConfig) {
  const cliEngineConfig = {
    rules,
    ignore: !config.advanced.disableEslintIgnore,
    fix: type === 'fix'
  };
  cliEngineConfig.rulePaths = config.advanced.eslintRulesDirs.map(path => {
    const rulesDir = cleanPath(path);

    if (!_path.default.isAbsolute(rulesDir)) {
      return (0, _atomLinter.findCached)(_path.default.dirname(filePath), rulesDir);
    }

    return rulesDir;
  }).filter(path => path);

  if (fileConfig === null && config.global.eslintrcPath) {
    // If we didn't find a configuration use the fallback from the settings
    cliEngineConfig.configFile = cleanPath(config.global.eslintrcPath);
  }

  return cliEngineConfig;
}
/**
 * Gets the list of rules used for a lint job
 * @param  {import("eslint").CLIEngine} cliEngine The CLIEngine instance used for the lint job
 * @return {Map}              A Map of the rules used, rule names as keys, rule
 *                            properties as the contents.
 */


function getRules(cliEngine) {
  // Pull the list of rules used directly from the CLIEngine
  if (typeof cliEngine.getRules === 'function') {
    return cliEngine.getRules();
  } // Attempt to use the internal (undocumented) `linter` instance attached to
  // the CLIEngine to get the loaded rules (including plugin rules).
  // Added in ESLint v4


  if (Object.prototype.hasOwnProperty.call(cliEngine, 'linter')) {
    return cliEngine.linter.getRules();
  } // Older versions of ESLint don't (easily) support getting a list of rules


  return new Map();
}
/**
 * Given an exiting rule list and a new rule list, determines whether there
 * have been changes.
 * NOTE: This only accounts for presence of the rules, changes to their metadata
 * are not taken into account.
 * @param  {Map} newRules     A Map of the new rules
 * @param  {Map} currentRules A Map of the current rules
 * @return {boolean}             Whether or not there were changes
 */


function didRulesChange(currentRules, newRules) {
  return !(currentRules.size === newRules.size && Array.from(currentRules.keys()).every(ruleId => newRules.has(ruleId)));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93b3JrZXItaGVscGVycy5qcyJdLCJuYW1lcyI6WyJDYWNoZSIsIkVTTElOVF9MT0NBTF9QQVRIIiwiUGF0aCIsIm5vcm1hbGl6ZSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJOT0RFX1BSRUZJWF9QQVRIIiwiTEFTVF9NT0RVTEVTX1BBVEgiLCJjbGVhblBhdGgiLCJwYXRoIiwiZnMiLCJnZXROb2RlUHJlZml4UGF0aCIsIm5wbUNvbW1hbmQiLCJwcm9jZXNzIiwicGxhdGZvcm0iLCJDaGlsZFByb2Nlc3MiLCJzcGF3blN5bmMiLCJlbnYiLCJPYmplY3QiLCJhc3NpZ24iLCJQQVRIIiwib3V0cHV0IiwidG9TdHJpbmciLCJ0cmltIiwiZSIsImVyck1zZyIsIkVycm9yIiwiaXNEaXJlY3RvcnkiLCJkaXJQYXRoIiwiaXNEaXIiLCJzdGF0U3luYyIsImZhbGxiYWNrRm9yR2xvYmFsRXJyb3JUaHJvd24iLCJmaW5kRVNMaW50RGlyZWN0b3J5IiwibW9kdWxlc0RpciIsImNvbmZpZyIsInByb2plY3RQYXRoIiwiZmFsbGJhY2tGb3JHbG9iYWwiLCJlc2xpbnREaXIiLCJsb2NhdGlvblR5cGUiLCJnbG9iYWwiLCJ1c2VHbG9iYWxFc2xpbnQiLCJjb25maWdHbG9iYWwiLCJnbG9iYWxOb2RlUGF0aCIsInByZWZpeFBhdGgiLCJhZHZhbmNlZCIsImxvY2FsTm9kZU1vZHVsZXMiLCJpc0Fic29sdXRlIiwidHlwZSIsImNvbnNvbGUiLCJlcnJvciIsImdldEVTTGludEZyb21EaXJlY3RvcnkiLCJFU0xpbnREaXJlY3RvcnkiLCJyZXF1aXJlIiwiY29kZSIsInJlZnJlc2hNb2R1bGVzUGF0aCIsIk5PREVfUEFUSCIsIk1vZHVsZSIsIl9pbml0UGF0aHMiLCJnZXRFU0xpbnRJbnN0YW5jZSIsImZpbGVEaXIiLCJkaXJuYW1lIiwibG9nIiwiYXJncyIsIm9iaiIsImxlbmd0aCIsInN0ciIsIkpTT04iLCJzdHJpbmdpZnkiLCJVdGlsIiwiaW5zcGVjdCIsImVtaXQiLCJnZXRDb25maWdGb3JGaWxlIiwiZXNsaW50IiwiZmlsZVBhdGgiLCJjbGkiLCJDTElFbmdpbmUiLCJnZXRSZWxhdGl2ZVBhdGgiLCJpZ25vcmVGaWxlIiwiZGlzYWJsZUVzbGludElnbm9yZSIsImlnbm9yZURpciIsImNoZGlyIiwicmVsYXRpdmUiLCJiYXNlbmFtZSIsImdldENMSUVuZ2luZU9wdGlvbnMiLCJydWxlcyIsImZpbGVDb25maWciLCJjbGlFbmdpbmVDb25maWciLCJpZ25vcmUiLCJmaXgiLCJydWxlUGF0aHMiLCJlc2xpbnRSdWxlc0RpcnMiLCJtYXAiLCJydWxlc0RpciIsImZpbHRlciIsImVzbGludHJjUGF0aCIsImNvbmZpZ0ZpbGUiLCJnZXRSdWxlcyIsImNsaUVuZ2luZSIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImxpbnRlciIsIk1hcCIsImRpZFJ1bGVzQ2hhbmdlIiwiY3VycmVudFJ1bGVzIiwibmV3UnVsZXMiLCJzaXplIiwiQXJyYXkiLCJmcm9tIiwia2V5cyIsImV2ZXJ5IiwicnVsZUlkIiwiaGFzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBUkE7QUFVQSxNQUFNQSxLQUFLLEdBQUc7QUFDWkMsRUFBQUEsaUJBQWlCLEVBQUVDLGNBQUtDLFNBQUwsQ0FBZUQsY0FBS0UsSUFBTCxDQUFVQyxTQUFWLEVBQXFCLElBQXJCLEVBQTJCLGNBQTNCLEVBQTJDLFFBQTNDLENBQWYsQ0FEUDtBQUVaQyxFQUFBQSxnQkFBZ0IsRUFBRSxJQUZOO0FBR1pDLEVBQUFBLGlCQUFpQixFQUFFO0FBSFAsQ0FBZDtBQU1BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQSxNQUFNQyxTQUFTLEdBQUdDLElBQUksSUFBS0EsSUFBSSxHQUFHLHlCQUFXQyxnQkFBR1AsU0FBSCxDQUFhTSxJQUFiLENBQVgsQ0FBSCxHQUFvQyxFQUFuRTtBQUVBO0FBQ0E7QUFDQTs7O0FB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QUFoQyxDQUFzQ0MsTUFBTSxJQUFJTixRQUFRLENBQUNPLEdBQVQsQ0FBYUQsTUFBYixDQUFoRCxDQURFLENBQVA7QUFFRCIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBlbWl0ICovXG5cbmltcG9ydCBQYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgVXRpbCBmcm9tICd1dGlsJ1xuaW1wb3J0IGZzIGZyb20gJ2ZzLXBsdXMnXG5pbXBvcnQgQ2hpbGRQcm9jZXNzIGZyb20gJ2NoaWxkX3Byb2Nlc3MnXG5pbXBvcnQgcmVzb2x2ZUVudiBmcm9tICdyZXNvbHZlLWVudidcbmltcG9ydCB7IGZpbmRDYWNoZWQgfSBmcm9tICdhdG9tLWxpbnRlcidcbmltcG9ydCBnZXRQYXRoIGZyb20gJ2NvbnNpc3RlbnQtcGF0aCdcblxuY29uc3QgQ2FjaGUgPSB7XG4gIEVTTElOVF9MT0NBTF9QQVRIOiBQYXRoLm5vcm1hbGl6ZShQYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnbm9kZV9tb2R1bGVzJywgJ2VzbGludCcpKSxcbiAgTk9ERV9QUkVGSVhfUEFUSDogbnVsbCxcbiAgTEFTVF9NT0RVTEVTX1BBVEg6IG51bGxcbn1cblxuLyoqXG4gKiBUYWtlcyBhIHBhdGggYW5kIHRyYW5zbGF0ZXMgYH5gIHRvIHRoZSB1c2VyJ3MgaG9tZSBkaXJlY3RvcnksIGFuZCByZXBsYWNlc1xuICogYWxsIGVudmlyb25tZW50IHZhcmlhYmxlcyB3aXRoIHRoZWlyIHZhbHVlLlxuICogQHBhcmFtICB7c3RyaW5nfSBwYXRoIFRoZSBwYXRoIHRvIHJlbW92ZSBcInN0cmFuZ2VuZXNzXCIgZnJvbVxuICogQHJldHVybiB7c3RyaW5nfSAgICAgIFRoZSBjbGVhbmVkIHBhdGhcbiAqL1xuY29uc3QgY2xlYW5QYXRoID0gcGF0aCA9PiAocGF0aCA/IHJlc29sdmVFbnYoZnMubm9ybWFsaXplKHBhdGgpKSA6ICcnKVxuXG4vKipcbiAqIEByZXR1cm5zIHtzdHJpbmd9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXROb2RlUHJlZml4UGF0aCgpIHtcbiAgaWYgKENhY2hlLk5PREVfUFJFRklYX1BBVEggPT09IG51bGwpIHtcbiAgICBjb25zdCBucG1Db21tYW5kID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/ICducG0uY21kJyA6ICducG0nXG4gICAgdHJ5IHtcbiAgICAgIENhY2hlLk5PREVfUFJFRklYX1BBVEggPSBDaGlsZFByb2Nlc3Muc3Bhd25TeW5jKG5wbUNvbW1hbmQsIFsnZ2V0JywgJ3ByZWZpeCddLCB7XG4gICAgICAgIGVudjogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBwcm9jZXNzLmVudiksIHsgUEFUSDogZ2V0UGF0aCgpIH0pXG4gICAgICB9KS5vdXRwdXRbMV0udG9TdHJpbmcoKS50cmltKClcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zdCBlcnJNc2cgPSAnVW5hYmxlIHRvIGV4ZWN1dGUgYG5wbSBnZXQgcHJlZml4YC4gUGxlYXNlIG1ha2Ugc3VyZSAnXG4gICAgICAgICsgJ0F0b20gaXMgZ2V0dGluZyAkUEFUSCBjb3JyZWN0bHkuJ1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVyck1zZylcbiAgICB9XG4gIH1cbiAgcmV0dXJuIENhY2hlLk5PREVfUFJFRklYX1BBVEhcbn1cblxuLyoqXG4gKiBAcGFyYW0ge3N0cmluZ30gZGlyUGF0aFxuICogQHJldHVybnMge2Jvb2xlYW59XG4gKi9cbmZ1bmN0aW9uIGlzRGlyZWN0b3J5KGRpclBhdGgpIHtcbiAgbGV0IGlzRGlyXG4gIHRyeSB7XG4gICAgaXNEaXIgPSBmcy5zdGF0U3luYyhkaXJQYXRoKS5pc0RpcmVjdG9yeSgpXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpc0RpciA9IGZhbHNlXG4gIH1cbiAgcmV0dXJuIGlzRGlyXG59XG5cbmxldCBmYWxsYmFja0Zvckdsb2JhbEVycm9yVGhyb3duID0gZmFsc2VcblxuLyoqXG4gKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlc0RpclxuICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZ1xuICogQHBhcmFtIHtzdHJpbmd9IHByb2plY3RQYXRoXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGZhbGxiYWNrRm9yR2xvYmFsXG4gKiBAcmV0dXJucyB7eyBwYXRoOiBzdHJpbmcsIHR5cGU6ICdsb2NhbCBwcm9qZWN0JyB8ICdnbG9iYWwnIHwgJ2FkdmFuY2VkIHNwZWNpZmllZCcgfCAnYnVuZGxlZCBmYWxsYmFjaycgfX1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZpbmRFU0xpbnREaXJlY3RvcnkobW9kdWxlc0RpciwgY29uZmlnLCBwcm9qZWN0UGF0aCwgZmFsbGJhY2tGb3JHbG9iYWwgPSBmYWxzZSkge1xuICBsZXQgZXNsaW50RGlyID0gbnVsbFxuICBsZXQgbG9jYXRpb25UeXBlID0gbnVsbFxuICBpZiAoY29uZmlnLmdsb2JhbC51c2VHbG9iYWxFc2xpbnQgJiYgIWZhbGxiYWNrRm9yR2xvYmFsKSB7XG4gICAgbG9jYXRpb25UeXBlID0gJ2dsb2JhbCdcbiAgICBjb25zdCBjb25maWdHbG9iYWwgPSBjbGVhblBhdGgoY29uZmlnLmdsb2JhbC5nbG9iYWxOb2RlUGF0aClcbiAgICBjb25zdCBwcmVmaXhQYXRoID0gY29uZmlnR2xvYmFsIHx8IGdldE5vZGVQcmVmaXhQYXRoKClcbiAgICAvLyBOUE0gb24gV2luZG93cyBhbmQgWWFybiBvbiBhbGwgcGxhdGZvcm1zXG4gICAgZXNsaW50RGlyID0gUGF0aC5qb2luKHByZWZpeFBhdGgsICdub2RlX21vZHVsZXMnLCAnZXNsaW50JylcbiAgICBpZiAoIWlzRGlyZWN0b3J5KGVzbGludERpcikpIHtcbiAgICAgIC8vIE5QTSBvbiBwbGF0Zm9ybXMgb3RoZXIgdGhhbiBXaW5kb3dzXG4gICAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4ocHJlZml4UGF0aCwgJ2xpYicsICdub2RlX21vZHVsZXMnLCAnZXNsaW50JylcbiAgICB9XG4gIH0gZWxzZSBpZiAoIWNvbmZpZy5hZHZhbmNlZC5sb2NhbE5vZGVNb2R1bGVzKSB7XG4gICAgbG9jYXRpb25UeXBlID0gJ2xvY2FsIHByb2plY3QnXG4gICAgZXNsaW50RGlyID0gUGF0aC5qb2luKG1vZHVsZXNEaXIgfHwgJycsICdlc2xpbnQnKVxuICB9IGVsc2UgaWYgKFBhdGguaXNBYnNvbHV0ZShjbGVhblBhdGgoY29uZmlnLmFkdmFuY2VkLmxvY2FsTm9kZU1vZHVsZXMpKSkge1xuICAgIGxvY2F0aW9uVHlwZSA9ICdhZHZhbmNlZCBzcGVjaWZpZWQnXG4gICAgZXNsaW50RGlyID0gUGF0aC5qb2luKGNsZWFuUGF0aChjb25maWcuYWR2YW5jZWQubG9jYWxOb2RlTW9kdWxlcyksICdlc2xpbnQnKVxuICB9IGVsc2Uge1xuICAgIGxvY2F0aW9uVHlwZSA9ICdhZHZhbmNlZCBzcGVjaWZpZWQnXG4gICAgZXNsaW50RGlyID0gUGF0aC5qb2luKHByb2plY3RQYXRoIHx8ICcnLCBjbGVhblBhdGgoY29uZmlnLmFkdmFuY2VkLmxvY2FsTm9kZU1vZHVsZXMpLCAnZXNsaW50JylcbiAgfVxuXG4gIGlmIChpc0RpcmVjdG9yeShlc2xpbnREaXIpKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBhdGg6IGVzbGludERpcixcbiAgICAgIHR5cGU6IGxvY2F0aW9uVHlwZSxcbiAgICB9XG4gIH1cblxuICBpZiAoY29uZmlnLmdsb2JhbC51c2VHbG9iYWxFc2xpbnQgJiYgIWZhbGxiYWNrRm9yR2xvYmFsKSB7XG4gICAgaWYgKCFmYWxsYmFja0Zvckdsb2JhbEVycm9yVGhyb3duKSB7XG4gICAgICAvLyBUaHJvdyB0aGUgZXJyb3Igb25seSBvbmNlIHRvIHByZXZlbnQgcGVyZm9ybWFuY2UgaXNzdWVzXG4gICAgICBmYWxsYmFja0Zvckdsb2JhbEVycm9yVGhyb3duID0gdHJ1ZVxuICAgICAgY29uc29sZS5lcnJvcihgR2xvYmFsIEVTTGludCBpcyBub3QgZm91bmQsIGZhbGxpbmcgYmFjayB0byBvdGhlciBFc2xpbnQgaW5zdGFsbGF0aW9ucy4uLlxuICAgICAgICBQbGVhc2UgZW5zdXJlIHRoZSBnbG9iYWwgTm9kZSBwYXRoIGlzIHNldCBjb3JyZWN0bHkuXG4gICAgICAgIElmIHlvdSB3YW50ZWQgdG8gdXNlIGEgbG9jYWwgaW5zdGFsbGF0aW9uIG9mIEVzbGludCwgZGlzYWJsZSBHbG9iYWwgRXNsaW50IG9wdGlvbiBpbiB0aGUgbGludGVyLWVzbGludCBjb25maWcuYClcbiAgICB9XG4gICAgcmV0dXJuIGZpbmRFU0xpbnREaXJlY3RvcnkobW9kdWxlc0RpciwgY29uZmlnLCBwcm9qZWN0UGF0aCwgdHJ1ZSlcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcGF0aDogQ2FjaGUuRVNMSU5UX0xPQ0FMX1BBVEgsXG4gICAgdHlwZTogJ2J1bmRsZWQgZmFsbGJhY2snLFxuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZXNEaXJcbiAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWdcbiAqIEBwYXJhbSB7c3RyaW5nfSBwcm9qZWN0UGF0aFxuICogQHJldHVybnMge2ltcG9ydChcImVzbGludFwiKX1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEVTTGludEZyb21EaXJlY3RvcnkobW9kdWxlc0RpciwgY29uZmlnLCBwcm9qZWN0UGF0aCkge1xuICBjb25zdCB7IHBhdGg6IEVTTGludERpcmVjdG9yeSB9ID0gZmluZEVTTGludERpcmVjdG9yeShtb2R1bGVzRGlyLCBjb25maWcsIHByb2plY3RQYXRoKVxuICB0cnkge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgcmV0dXJuIHJlcXVpcmUoRVNMaW50RGlyZWN0b3J5KVxuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGNvbmZpZy5nbG9iYWwudXNlR2xvYmFsRXNsaW50ICYmIGUuY29kZSA9PT0gJ01PRFVMRV9OT1RfRk9VTkQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VTTGludCBub3QgZm91bmQsIHRyeSByZXN0YXJ0aW5nIEF0b20gdG8gY2xlYXIgY2FjaGVzLicpXG4gICAgfVxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgcmV0dXJuIHJlcXVpcmUoQ2FjaGUuRVNMSU5UX0xPQ0FMX1BBVEgpXG4gIH1cbn1cblxuLyoqXG4gKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlc0RpclxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVmcmVzaE1vZHVsZXNQYXRoKG1vZHVsZXNEaXIpIHtcbiAgaWYgKENhY2hlLkxBU1RfTU9EVUxFU19QQVRIICE9PSBtb2R1bGVzRGlyKSB7XG4gICAgQ2FjaGUuTEFTVF9NT0RVTEVTX1BBVEggPSBtb2R1bGVzRGlyXG4gICAgcHJvY2Vzcy5lbnYuTk9ERV9QQVRIID0gbW9kdWxlc0RpciB8fCAnJ1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlcnNjb3JlLWRhbmdsZVxuICAgIHJlcXVpcmUoJ21vZHVsZScpLk1vZHVsZS5faW5pdFBhdGhzKClcbiAgfVxufVxuXG4vLyBleHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RVNMaW50QmluYXJ5KHJvb3RQYXRoKSB7XG4vLyAgIGNvbnN0IHBsYXRmb3JtID0gcHJvY2Vzcy5wbGF0Zm9ybTtcbi8vICAgaWYgKHBsYXRmb3JtID09PSAnd2luMzInICYmIGF3YWl0IGZzLmV4aXN0cyhQYXRoLmpvaW4ocm9vdFBhdGgsICdub2RlX21vZHVsZXMnLCAnLmJpbicsICdlc2xpbnQuY21kJykpKSB7XG4vLyAgICAgcmV0dXJuIFBhdGguam9pbignLicsICdub2RlX21vZHVsZXMnLCAnLmJpbicsICdlc2xpbnQuY21kJyk7XG4vLyAgIH0gZWxzZSBpZiAoKHBsYXRmb3JtID09PSAnbGludXgnIHx8IHBsYXRmb3JtID09PSAnZGFyd2luJylcbi8vICAgICAmJiBhd2FpdCBmcy5leGlzdHMoUGF0aC5qb2luKHJvb3RQYXRoLCAnbm9kZV9tb2R1bGVzJywgJy5iaW4nLCAnZXNsaW50JykpKSB7XG4vLyAgICAgcmV0dXJuIFBhdGguam9pbignLicsICdub2RlX21vZHVsZXMnLCAnLmJpbicsICdlc2xpbnQnKTtcbi8vICAgfSBlbHNlIHtcbi8vICAgICByZXR1cm4gJ2VzbGludCc7XG4vLyAgIH1cbi8vIH1cblxuLyoqXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZURpclxuICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZ1xuICogQHBhcmFtIHtzdHJpbmd9IHByb2plY3RQYXRoXG4gKiBAcmV0dXJucyB7aW1wb3J0KFwiZXNsaW50XCIpfVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RVNMaW50SW5zdGFuY2UoZmlsZURpciwgY29uZmlnLCBwcm9qZWN0UGF0aCkge1xuICBjb25zdCBtb2R1bGVzRGlyID0gUGF0aC5kaXJuYW1lKGZpbmRDYWNoZWQoZmlsZURpciwgJ25vZGVfbW9kdWxlcy9lc2xpbnQnKSB8fCAnJylcbiAgcmVmcmVzaE1vZHVsZXNQYXRoKG1vZHVsZXNEaXIpXG4gIHJldHVybiBnZXRFU0xpbnRGcm9tRGlyZWN0b3J5KG1vZHVsZXNEaXIsIGNvbmZpZywgcHJvamVjdFBhdGgpXG59XG5cbi8qKlxuICogY29uc29sZS5sb2dcbiAqIEBwYXJhbSAge2FueX0gYXJnc1xuICogQHJldHVybiB7dm9pZH1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGxvZyguLi5hcmdzKSB7XG4gIGNvbnN0IG9iaiA9IGFyZ3MubGVuZ3RoID09PSAxID8gYXJnc1swXSA6IGFyZ3NcbiAgbGV0IHN0clxuICB0cnkge1xuICAgIHN0ciA9IEpTT04uc3RyaW5naWZ5KG9iailcbiAgfSBjYXRjaCAoZSkge1xuICAgIHN0ciA9IFV0aWwuaW5zcGVjdChvYmopXG4gIH1cblxuICBlbWl0KCdsb2cnLCBzdHIpXG59XG5cbi8qKlxuICogQHBhcmFtIHtpbXBvcnQoXCJlc2xpbnRcIil9IGVzbGludFxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb25maWdGb3JGaWxlKGVzbGludCwgZmlsZVBhdGgpIHtcbiAgY29uc3QgY2xpID0gbmV3IGVzbGludC5DTElFbmdpbmUoKVxuICB0cnkge1xuICAgIHJldHVybiBjbGkuZ2V0Q29uZmlnRm9yRmlsZShmaWxlUGF0aClcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIE5vIGNvbmZpZ3VyYXRpb24gd2FzIGZvdW5kXG4gICAgcmV0dXJuIG51bGxcbiAgfVxufVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlRGlyXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZVBhdGhcbiAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWdcbiAqIEBwYXJhbSB7c3RyaW5nfSBwcm9qZWN0UGF0aFxuICogQHJldHVybnMge3N0cmluZ31cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFJlbGF0aXZlUGF0aChmaWxlRGlyLCBmaWxlUGF0aCwgY29uZmlnLCBwcm9qZWN0UGF0aCkge1xuICBjb25zdCBpZ25vcmVGaWxlID0gY29uZmlnLmFkdmFuY2VkLmRpc2FibGVFc2xpbnRJZ25vcmUgPyBudWxsIDogZmluZENhY2hlZChmaWxlRGlyLCAnLmVzbGludGlnbm9yZScpXG5cbiAgLy8gSWYgd2UgY2FuIGZpbmQgYW4gLmVzbGludGlnbm9yZSBmaWxlLCB3ZSBjYW4gc2V0IGN3ZCB0aGVyZVxuICAvLyAoYmVjYXVzZSB0aGV5IGFyZSBleHBlY3RlZCB0byBiZSBhdCB0aGUgcHJvamVjdCByb290KVxuICBpZiAoaWdub3JlRmlsZSkge1xuICAgIGNvbnN0IGlnbm9yZURpciA9IFBhdGguZGlybmFtZShpZ25vcmVGaWxlKVxuICAgIHByb2Nlc3MuY2hkaXIoaWdub3JlRGlyKVxuICAgIHJldHVybiBQYXRoLnJlbGF0aXZlKGlnbm9yZURpciwgZmlsZVBhdGgpXG4gIH1cbiAgLy8gT3RoZXJ3aXNlLCB3ZSdsbCBzZXQgdGhlIGN3ZCB0byB0aGUgYXRvbSBwcm9qZWN0IHJvb3QgYXMgbG9uZyBhcyB0aGF0IGV4aXN0c1xuICBpZiAocHJvamVjdFBhdGgpIHtcbiAgICBwcm9jZXNzLmNoZGlyKHByb2plY3RQYXRoKVxuICAgIHJldHVybiBQYXRoLnJlbGF0aXZlKHByb2plY3RQYXRoLCBmaWxlUGF0aClcbiAgfVxuICAvLyBJZiBhbGwgZWxzZSBmYWlscywgdXNlIHRoZSBmaWxlIGxvY2F0aW9uIGl0c2VsZlxuICBwcm9jZXNzLmNoZGlyKGZpbGVEaXIpXG4gIHJldHVybiBQYXRoLmJhc2VuYW1lKGZpbGVQYXRoKVxufVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXG4gKiBAcGFyYW0ge3N0cmluZ1tdfSBydWxlc1xuICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZ1xuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoXG4gKiBAcGFyYW0ge29iamVjdH0gZmlsZUNvbmZpZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q0xJRW5naW5lT3B0aW9ucyh0eXBlLCBjb25maWcsIHJ1bGVzLCBmaWxlUGF0aCwgZmlsZUNvbmZpZykge1xuICBjb25zdCBjbGlFbmdpbmVDb25maWcgPSB7XG4gICAgcnVsZXMsXG4gICAgaWdub3JlOiAhY29uZmlnLmFkdmFuY2VkLmRpc2FibGVFc2xpbnRJZ25vcmUsXG4gICAgZml4OiB0eXBlID09PSAnZml4J1xuICB9XG5cbiAgY2xpRW5naW5lQ29uZmlnLnJ1bGVQYXRocyA9IGNvbmZpZy5hZHZhbmNlZC5lc2xpbnRSdWxlc0RpcnMubWFwKChwYXRoKSA9PiB7XG4gICAgY29uc3QgcnVsZXNEaXIgPSBjbGVhblBhdGgocGF0aClcbiAgICBpZiAoIVBhdGguaXNBYnNvbHV0ZShydWxlc0RpcikpIHtcbiAgICAgIHJldHVybiBmaW5kQ2FjaGVkKFBhdGguZGlybmFtZShmaWxlUGF0aCksIHJ1bGVzRGlyKVxuICAgIH1cbiAgICByZXR1cm4gcnVsZXNEaXJcbiAgfSkuZmlsdGVyKHBhdGggPT4gcGF0aClcblxuICBpZiAoZmlsZUNvbmZpZyA9PT0gbnVsbCAmJiBjb25maWcuZ2xvYmFsLmVzbGludHJjUGF0aCkge1xuICAgIC8vIElmIHdlIGRpZG4ndCBmaW5kIGEgY29uZmlndXJhdGlvbiB1c2UgdGhlIGZhbGxiYWNrIGZyb20gdGhlIHNldHRpbmdzXG4gICAgY2xpRW5naW5lQ29uZmlnLmNvbmZpZ0ZpbGUgPSBjbGVhblBhdGgoY29uZmlnLmdsb2JhbC5lc2xpbnRyY1BhdGgpXG4gIH1cblxuICByZXR1cm4gY2xpRW5naW5lQ29uZmlnXG59XG5cbi8qKlxuICogR2V0cyB0aGUgbGlzdCBvZiBydWxlcyB1c2VkIGZvciBhIGxpbnQgam9iXG4gKiBAcGFyYW0gIHtpbXBvcnQoXCJlc2xpbnRcIikuQ0xJRW5naW5lfSBjbGlFbmdpbmUgVGhlIENMSUVuZ2luZSBpbnN0YW5jZSB1c2VkIGZvciB0aGUgbGludCBqb2JcbiAqIEByZXR1cm4ge01hcH0gICAgICAgICAgICAgIEEgTWFwIG9mIHRoZSBydWxlcyB1c2VkLCBydWxlIG5hbWVzIGFzIGtleXMsIHJ1bGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXMgYXMgdGhlIGNvbnRlbnRzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UnVsZXMoY2xpRW5naW5lKSB7XG4gIC8vIFB1bGwgdGhlIGxpc3Qgb2YgcnVsZXMgdXNlZCBkaXJlY3RseSBmcm9tIHRoZSBDTElFbmdpbmVcbiAgaWYgKHR5cGVvZiBjbGlFbmdpbmUuZ2V0UnVsZXMgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gY2xpRW5naW5lLmdldFJ1bGVzKClcbiAgfVxuXG4gIC8vIEF0dGVtcHQgdG8gdXNlIHRoZSBpbnRlcm5hbCAodW5kb2N1bWVudGVkKSBgbGludGVyYCBpbnN0YW5jZSBhdHRhY2hlZCB0b1xuICAvLyB0aGUgQ0xJRW5naW5lIHRvIGdldCB0aGUgbG9hZGVkIHJ1bGVzIChpbmNsdWRpbmcgcGx1Z2luIHJ1bGVzKS5cbiAgLy8gQWRkZWQgaW4gRVNMaW50IHY0XG4gIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoY2xpRW5naW5lLCAnbGludGVyJykpIHtcbiAgICByZXR1cm4gY2xpRW5naW5lLmxpbnRlci5nZXRSdWxlcygpXG4gIH1cblxuICAvLyBPbGRlciB2ZXJzaW9ucyBvZiBFU0xpbnQgZG9uJ3QgKGVhc2lseSkgc3VwcG9ydCBnZXR0aW5nIGEgbGlzdCBvZiBydWxlc1xuICByZXR1cm4gbmV3IE1hcCgpXG59XG5cbi8qKlxuICogR2l2ZW4gYW4gZXhpdGluZyBydWxlIGxpc3QgYW5kIGEgbmV3IHJ1bGUgbGlzdCwgZGV0ZXJtaW5lcyB3aGV0aGVyIHRoZXJlXG4gKiBoYXZlIGJlZW4gY2hhbmdlcy5cbiAqIE5PVEU6IFRoaXMgb25seSBhY2NvdW50cyBmb3IgcHJlc2VuY2Ugb2YgdGhlIHJ1bGVzLCBjaGFuZ2VzIHRvIHRoZWlyIG1ldGFkYXRhXG4gKiBhcmUgbm90IHRha2VuIGludG8gYWNjb3VudC5cbiAqIEBwYXJhbSAge01hcH0gbmV3UnVsZXMgICAgIEEgTWFwIG9mIHRoZSBuZXcgcnVsZXNcbiAqIEBwYXJhbSAge01hcH0gY3VycmVudFJ1bGVzIEEgTWFwIG9mIHRoZSBjdXJyZW50IHJ1bGVzXG4gKiBAcmV0dXJuIHtib29sZWFufSAgICAgICAgICAgICBXaGV0aGVyIG9yIG5vdCB0aGVyZSB3ZXJlIGNoYW5nZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRpZFJ1bGVzQ2hhbmdlKGN1cnJlbnRSdWxlcywgbmV3UnVsZXMpIHtcbiAgcmV0dXJuICEoY3VycmVudFJ1bGVzLnNpemUgPT09IG5ld1J1bGVzLnNpemVcbiAgICAmJiBBcnJheS5mcm9tKGN1cnJlbnRSdWxlcy5rZXlzKCkpLmV2ZXJ5KHJ1bGVJZCA9PiBuZXdSdWxlcy5oYXMocnVsZUlkKSkpXG59XG4iXX0=